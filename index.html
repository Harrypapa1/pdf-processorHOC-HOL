<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Order Processing System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            border: 3px dashed #e3e8ef;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-section.dragover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-text h3 {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-text p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .admin-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #e3e8ef;
        }
        
        .admin-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            margin: 20px 0;
        }
        
        .admin-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .admin-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
        }
        
        .processing-section {
            display: none;
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: #e3e8ef;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .results-section {
            display: none;
            margin: 30px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .order-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
            overflow: hidden;
            border-left: 5px solid #667eea;
        }
        
        .order-header {
            background: #f8fafc;
            padding: 20px 30px;
            border-bottom: 1px solid #e3e8ef;
        }
        
        .order-header h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .order-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .order-body {
            padding: 30px;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .products-table th,
        .products-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e3e8ef;
        }
        
        .products-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .export-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 30px 0;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“§ Email Order Processing</h1>
            <p>Transform PDF orders into Excel files for Freshware</p>
        </div>
        
        <div class="main-content">
            <!-- File Upload Section -->
            <div class="upload-section" id="uploadArea">
                <div class="upload-icon">ðŸ“Ž</div>
                <div class="upload-text">
                    <h3>Drop PDF files here or click to browse</h3>
                    <p>Support for consolidated and standard purchase orders</p>
                </div>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Choose Files
                </button>
            </div>

            <!-- Customer Email Management Section -->
            <div class="admin-section">
                <h3>ðŸ”§ Customer Email Management</h3>
                
                <div class="admin-grid">
                    <input type="text" id="customerCode" placeholder="Customer Code (e.g., 07BELLA)" class="admin-input">
                    <input type="text" id="customerName" placeholder="Customer Name" class="admin-input">
                    <input type="email" id="customerEmail" placeholder="customer@email.com" class="admin-input">
                    <button class="btn" onclick="addSingleCustomerEmail()">Add Email</button>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Batch Upload CSV</h4>
                    <textarea id="csvEmails" rows="5" placeholder="CustomerCode,CustomerName,Email&#10;07BELLA,BELLA_KITCHEN,bella@example.com&#10;13RREST,RIVER_KITCHEN,river@example.com" class="admin-textarea"></textarea>
                    <button class="btn" onclick="batchUploadEmails()" style="margin-top: 10px;">Upload Batch</button>
                </div>
                
                <div>
                    <button class="btn" onclick="showCurrentMappings()">Show All Mappings</button>
                    <span id="mappingCount" style="margin-left: 15px; color: #666;"></span>
                </div>
            </div>
            
            <!-- Processing Section -->
            <div class="processing-section" id="processingSection">
                <h3>ðŸ”„ Processing Orders...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="processingStatus">Initializing...</p>
            </div>
            
            <div class="results-section" id="resultsSection">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Orders Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">Products Found</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="mappedProducts">0</div>
                        <div class="stat-label">Mapped Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalValue">Â£0</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                </div>
                
                <div id="ordersContainer"></div>
                
                <!-- Export Section -->
                <div class="export-section">
                    <h3>ðŸ“Š Ready to Export</h3>
                    <p>All orders have been processed and are ready for Freshware import</p>
                    <button class="btn btn-success" onclick="exportToExcel()">
                        Download Excel File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDeNUflDD7eEiZS9ZE5Z1WwiAMP8Nx4krY",
            authDomain: "email-order-system.firebaseapp.com",
            projectId: "email-order-system",
            storageBucket: "email-order-system.firebasestorage.app",
            messagingSenderId: "148310260005",
            appId: "1:148310260005:web:65014f7b35ebd7e46ec2cc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let processedOrders = [];
        let customerMappings = new Map();
        let productMappings = new Map();
        let emailMappingsCache = new Map();
        let lastCacheUpdate = 0;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // Firebase Functions
        async function loadCustomerEmailsFromFirestore() {
            try {
                console.log('Loading customer emails from Firestore...');
                
                const snapshot = await db.collection('customerEmails').get();
                
                emailMappingsCache.clear();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    emailMappingsCache.set(data.customerCode, data.email);
                    if (data.customerName) {
                        emailMappingsCache.set(data.customerName, data.email);
                    }
                });
                
                lastCacheUpdate = Date.now();
                console.log(`Loaded ${emailMappingsCache.size} customer email mappings`);
                updateMappingCount();
                
                return emailMappingsCache;
            } catch (error) {
                console.error('Error loading customer emails:', error);
                return emailMappingsCache;
            }
        }

        async function getCustomerEmail(customerCode, customerName) {
            if (Date.now() - lastCacheUpdate > CACHE_DURATION) {
                await loadCustomerEmailsFromFirestore();
            }
            
            return emailMappingsCache.get(customerCode) || 
                   emailMappingsCache.get(customerName) || 
                   '';
        }

        async function addCustomerEmail(customerCode, customerName, email) {
            try {
                const docData = {
                    customerCode: customerCode,
                    customerName: customerName,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('customerEmails').doc(customerCode).set(docData);
                
                emailMappingsCache.set(customerCode, email);
                if (customerName) {
                    emailMappingsCache.set(customerName, email);
                }
                
                console.log(`Added email mapping: ${customerCode} -> ${email}`);
                updateMappingCount();
                return true;
            } catch (error) {
                console.error('Error adding customer email:', error);
                return false;
            }
        }

        async function batchUploadCustomerEmails(csvText) {
            try {
                const lines = csvText.trim().split('\n');
                const batch = db.batch();
                let count = 0;
                
                for (const line of lines) {
                    const [customerCode, customerName, email] = line.split(',').map(s => s.trim());
                    
                    if (customerCode && email) {
                        const docRef = db.collection('customerEmails').doc(customerCode);
                        batch.set(docRef, {
                            customerCode,
                            customerName: customerName || customerCode,
                            email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        count++;
                    }
                }
                
                await batch.commit();
                console.log(`Batch uploaded ${count} customer email mappings`);
                
                await loadCustomerEmailsFromFirestore();
                return count;
            } catch (error) {
                console.error('Error batch uploading:', error);
                throw error;
            }
        }

        // UI Functions for Email Management
        async function addSingleCustomerEmail() {
            const code = document.getElementById('customerCode').value.trim();
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            
            if (!code || !email) {
                alert('Customer Code and Email are required');
                return;
            }
            
            const success = await addCustomerEmail(code, name, email);
            if (success) {
                alert('Customer email added successfully!');
                document.getElementById('customerCode').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('customerEmail').value = '';
            } else {
                alert('Error adding customer email');
            }
        }

        async function batchUploadEmails() {
            const csvText = document.getElementById('csvEmails').value.trim();
            
            if (!csvText) {
                alert('Please enter CSV data');
                return;
            }
            
            try {
                const count = await batchUploadCustomerEmails(csvText);
                alert(`Successfully uploaded ${count} customer email mappings!`);
                document.getElementById('csvEmails').value = '';
            } catch (error) {
                alert('Error uploading emails: ' + error.message);
            }
        }

        function updateMappingCount() {
            const countElement = document.getElementById('mappingCount');
            if (countElement) {
                countElement.textContent = `${emailMappingsCache.size} email mappings loaded`;
            }
        }

        async function showCurrentMappings() {
            await loadCustomerEmailsFromFirestore();
            let mappingsList = '';
            emailMappingsCache.forEach((email, customer) => {
                mappingsList += `${customer}: ${email}\n`;
            });
            
            if (mappingsList) {
                alert('Current Email Mappings:\n\n' + mappingsList);
            } else {
                alert('No email mappings found. Add some using the form above.');
            }
        }
        
        // Initialize known mappings
        async function initializeMappings() {
            // Customer mappings
            customerMappings.set('07BELLA', 'BELLA_KITCHEN');
            customerMappings.set('13RREST', 'RIVER_KITCHEN');
            customerMappings.set('92TABLE', 'TABLE_KITCHEN');
            customerMappings.set('76RICH', 'RICHMOND_HOUSE');
            
            // Product mappings
            productMappings.set('AVO', 'AVOCADO_PEAR');
            productMappings.set('KI', 'KIWI_FRUIT');
            productMappings.set('PINL', 'PINEAPPLE_LARGE');
            productMappings.set('CAU', 'CAULIFLOWER');
            productMappings.set('PLUR', 'PLUMS');
            productMappings.set('SAT', 'SATSUMAS');
            productMappings.set('STR', 'STRAWBERRIES');
            productMappings.set('CEL', 'CELERY');
            productMappings.set('GRBS', 'GRAPES_BLACK'); 
            productMappings.set('GRWS', 'GRAPES_WHITE');
            productMappings.set('POSW', 'POTATO_SWEET');

            // Load email mappings from Firestore
            await loadCustomerEmailsFromFirestore();
        }
        
        // Initialize the application
        async function init() {
            await initializeMappings();
            setupEventListeners();
            console.log('App initialized successfully');
        }
        
        // Setup event listeners
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // File input change
            fileInput.addEventListener('change', handleFiles);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                const pdfFiles = files.filter(f => 
                    f.type === 'application/pdf' || 
                    f.name.toLowerCase().endsWith('.pdf')
                );
                
                if (pdfFiles.length > 0) {
                    processFiles(pdfFiles);
                } else {
                    alert('Please drop PDF files only.');
                }
            });
            
            uploadArea.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    fileInput.click();
                }
            });
        }
        
        // Handle file selection
        function handleFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                processFiles(files);
            }
        }
        
        // Process PDF files
        async function processFiles(files) {
            document.getElementById('processingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            processedOrders = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateProgress((i / files.length) * 100, `Processing ${file.name}...`);
                
                try {
                    const order = await processPDF(file);
                    if (order) {
                        processedOrders.push(order);
                    }
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    alert(`Error processing ${file.name}: ${error.message}`);
                }
            }
            
            updateProgress(100, 'Processing complete!');
            setTimeout(() => {
                document.getElementById('processingSection').style.display = 'none';
                displayResults();
            }, 1000);
        }
        
        // Real PDF processing with PDF.js
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                
                // Extract text from PDF
                const text = textContent.items.map(item => item.str).join(' ');
                
                // Determine template type and parse
                const isConsolidated = text.includes('Consolidated Purchase Order');
                
                if (isConsolidated) {
                    return parseConsolidatedOrder(text, file.name);
                } else {
                    return parseStandardOrder(text, file.name);
                }
            } catch (error) {
                console.error('Error processing PDF:', error);
                throw error;
            }
        }
        
        // Parse consolidated order template
        function parseConsolidatedOrder(text, filename) {
            const order = {
                filename: filename,
                type: 'Consolidated',
                customerCode: '',
                customerName: '',
                poNumber: '',
                orderDate: '',
                deliveryDate: '',
                products: [],
                total: 0
            };
            
            // Extract PO Number
            const poPatterns = [
                /PO Number:\s*([A-Z0-9]+)/i,
                /Purchase Order[^:]*:\s*([A-Z0-9]+)/i,
                /PO[:\s]+([A-Z0-9]+)/i
            ];
            
            for (const pattern of poPatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.poNumber = match[1];
                    break;
                }
            }
            
            // Extract dates
            const orderDatePatterns = [
                /Order Date:\s*(\d{2}\/\d{2}\/\d{4})/,
                /Date:\s*(\d{2}\/\d{2}\/\d{4})/
            ];
            
            for (const pattern of orderDatePatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.orderDate = match[1];
                    break;
                }
            }
            
            const deliveryDatePatterns = [
                /Delivery Date:\s*(\d{2}\/\d{2}\/\d{4})/,
                /Deliver[^:]*:\s*(\d{2}\/\d{2}\/\d{4})/
            ];
            
            for (const pattern of deliveryDatePatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.deliveryDate = match[1];
                    break;
                }
            }
            
            // Extract customer info
            const customerPatterns = [
                /following outlets[^:]*:\s*([^(]+)\s*\(([^)]+)\)/i,
                /outlets[^:]*:\s*([^(]+)\s*\(([^)]+)\)/i,
                /The\s+([^(]+)\s*\(([^)]+)\)/i
            ];
            
            for (const pattern of customerPatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.customerName = match[1].trim();
                    order.customerCode = match[2].trim();
                    break;
                }
            }
            
            // Extract products
            const productPatterns = [
                /(\d+\.?\d*)\s+([A-Z\s]+?)\s+([A-Z]+)\s+(1x[A-Za-z]+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g,
                /(\d+\.?\d*)\s+([A-Z][A-Z\s]+?)\s+([A-Z]{2,5})\s+([^\d]+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g
            ];
            
            for (const pattern of productPatterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const product = {
                        quantity: parseFloat(match[1]),
                        description: match[2].trim(),
                        productCode: match[3].trim(),
                        caseSize: match[4].trim(),
                        unitPrice: parseFloat(match[5]),
                        netPrice: parseFloat(match[6])
                    };
                    
                    if (product.quantity > 0 && product.productCode && product.unitPrice > 0) {
                        order.products.push(product);
                        order.total += product.netPrice;
                    }
                }
                
                if (order.products.length > 0) break;
            }
            
            // Extract total if products parsing failed
            if (order.total === 0) {
                const totalPatterns = [
                    /Net Total[:\s]+(\d+\.?\d*)/i,
                    /Total[:\s]+(\d+\.?\d*)/i
                ];
                
                for (const pattern of totalPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        order.total = parseFloat(match[1]);
                        break;
                    }
                }
            }
            
            return order;
        }
        
        // Parse standard order template  
        function parseStandardOrder(text, filename) {
            const order = {
                filename: filename,
                type: 'Standard',
                customerCode: '',
                customerName: '',
                poNumber: '',
                orderDate: '',
                deliveryDate: '',
                products: [],
                total: 0
            };
            
            // Extract PO Number
            const poMatch = text.match(/PO Number:\s*([A-Z0-9]+)/);
            if (poMatch) order.poNumber = poMatch[1];
            
            // Extract dates
            const orderDateMatch = text.match(/Order Date:\s*(\d{2}\/\d{2}\/\d{4})/);
            if (orderDateMatch) order.orderDate = orderDateMatch[1];
            
            const deliveryDateMatch = text.match(/Delivery Date:\s*(\d{2}\/\d{2}\/\d{4})/);
            if (deliveryDateMatch) order.deliveryDate = deliveryDateMatch[1];
            
            // Extract customer code from Account No
            const accountMatch = text.match(/Account No:\s*([A-Z0-9]+)/);
            if (accountMatch) order.customerCode = accountMatch[1];
            
            // Extract customer name from Deliver To section
            const deliverMatch = text.match(/Deliver To\s+([^\n]+)/);
            if (deliverMatch) order.customerName = deliverMatch[1].trim();
            
            // Extract products table
            const tablePattern = /(\d+\.?\d*)\s+([A-Z\s]+?)\s+([A-Z]+)\s+(1x\w+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g;
            let match;
            
            while ((match = tablePattern.exec(text)) !== null) {
                const product = {
                    quantity: parseFloat(match[1]),
                    description: match[2].trim(),
                    productCode: match[3].trim(),
                    caseSize: match[4].trim(),
                    unitPrice: parseFloat(match[5]),
                    netPrice: parseFloat(match[6])
                };
                order.products.push(product);
                order.total += product.netPrice;
            }
            
            return order;
        }
        
        // Update progress bar
        function updateProgress(percent, status) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('processingStatus').textContent = status;
        }
        
        // Display processing results
        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            const ordersContainer = document.getElementById('ordersContainer');
            
            // Update stats
            const totalProducts = processedOrders.reduce((sum, order) => sum + order.products.length, 0);
            const totalValue = processedOrders.reduce((sum, order) => sum + order.total, 0);
            
            document.getElementById('totalOrders').textContent = processedOrders.length;
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('mappedProducts').textContent = totalProducts;
            document.getElementById('totalValue').textContent = 'Â£' + totalValue.toFixed(2);
            
            // Clear previous results
            ordersContainer.innerHTML = '';
            
            // Display each order
            processedOrders.forEach((order, index) => {
                const orderCard = createOrderCard(order, index);
                ordersContainer.appendChild(orderCard);
            });
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Create order card HTML
        function createOrderCard(order, index) {
            const card = document.createElement('div');
            card.className = 'order-card';
            
            const customerMapping = customerMappings.get(order.customerCode) || order.customerCode;
            
            card.innerHTML = `
                <div class="order-header">
                    <h3>Order ${index + 1}: ${order.filename}</h3>
                    <div class="order-meta">
                        <div><strong>Type:</strong> ${order.type}</div>
                        <div><strong>PO Number:</strong> ${order.poNumber}</div>
                        <div><strong>Customer:</strong> ${order.customerName} (${order.customerCode} â†’ ${customerMapping})</div>
                        <div><strong>Order Date:</strong> ${order.orderDate}</div>
                        <div><strong>Delivery Date:</strong> ${order.deliveryDate}</div>
                        <div><strong>Total:</strong> Â£${order.total.toFixed(2)}</div>
                    </div>
                </div>
                <div class="order-body">
                    <h4>Products (${order.products.length} items)</h4>
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>Qty</th>
                                <th>Description</th>
                                <th>SKU Code</th>
                                <th>Case Size</th>
                                <th>Unit Price</th>
                                <th>Net</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.products.map(product => {
                                return `
                                    <tr>
                                        <td>${product.quantity}</td>
                                        <td>${product.description}</td>
                                        <td><strong>${product.productCode}</strong></td>
                                        <td>${product.caseSize}</td>
                                        <td>Â£${product.unitPrice.toFixed(2)}</td>
                                        <td>Â£${product.netPrice.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            return card;
        }
        
        // Export to Excel in Freshware format with email lookup
        async function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const wsData = [];
            
            // Add header row
            const headers = [
                "Name", "Email", "Financial Status", "Paid at", "Fulfillment Status", "Fulfilled at",
                "Accepts Marketing", "Currency", "Subtotal", "Shipping", "Taxes", "Total", 
                "Discount Code", "Discount Amount", "Shipping Method", "Created at", 
                "Lineitem quantity", "Lineitem name", "Lineitem price", "Lineitem compare at price",
                "Lineitem sku", "Lineitem requires shipping", "Lineitem taxable", "Lineitem fulfillment status",
                "Billing Name", "Billing Street", "Billing Address1", "Billing Address2", "Billing Company",
                "Billing City", "Billing Zip", "Billing Province", "Billing Country", "Billing Phone",
                "Shipping Name", "Shipping Street", "Shipping Address1", "Shipping Address2", "Shipping Company",
                "Shipping City", "Shipping Zip", "Shipping Province", "Shipping Country", "Shipping Phone",
                "Notes", "Note Attributes", "Cancelled at", "Payment Method", "Payment Reference",
                "Refunded Amount", "Vendor", "Outstanding Balance", "Employee", "Location", "Device ID",
                "Id", "Tags", "Risk Level", "Source", "Lineitem discount", "Tax 1 Name", "Tax 1 Value",
                "Tax 2 Name", "Tax 2 Value", "Tax 3 Name", "Tax 3 Value", "Tax 4 Name", "Tax 4 Value",
                "Tax 5 Name", "Tax 5 Value", "Phone", "Receipt Number", "Duties", "Billing Province Name",
                "Shipping Province Name", "Payment ID", "Payment Terms Name", "Next Payment Due At", "Payment References"
            ];
            wsData.push(headers);
            
            // Add data rows with email lookup
            for (const order of processedOrders) {
                for (let productIndex = 0; productIndex < order.products.length; productIndex++) {
                    const product = order.products[productIndex];
                    const row = new Array(79).fill("");
                    
                    // Generate order ID
                    const orderId = `WF${Math.floor(Math.random() * 90000) + 10000}`;
                    
                    // Get customer email from Firebase
                    const customerEmail = await getCustomerEmail(order.customerCode, order.customerName);
                    
                    // Fill data exactly like Freshware format
                    row[0] = orderId; // Name - order ID
                    row[1] = customerEmail; // Email - FROM FIREBASE!
                    row[2] = "pending"; // Financial Status
                    row[3] = ""; // Paid at
                    row[4] = "fulfilled"; // Fulfillment Status
                    row[5] = productIndex === 0 ? `${order.deliveryDate.split('/').reverse().join('-')} 21:21:42 +0100` : ""; // Fulfilled at
                    row[6] = "yes"; // Accepts Marketing
                    row[7] = "GBP"; // Currency
                    row[8] = productIndex === 0 ? order.total : ""; // Subtotal
                    row[9] = productIndex === 0 ? 0 : ""; // Shipping
                    row[10] = productIndex === 0 ? 0 : ""; // Taxes
                    row[11] = productIndex === 0 ? order.total : ""; // Total
                    row[12] = ""; // Discount Code
                    row[13] = ""; // Discount Amount
                    row[14] = productIndex === 0 ? "FREE DELIVERY" : ""; // Shipping Method
                    row[15] = `${order.orderDate.split('/').reverse().join('-')} 20:29:32 +0100`; // Created at
                    row[16] = product.quantity; // Lineitem quantity
                    row[17] = product.description; // Lineitem name
                    row[18] = product.unitPrice; // Lineitem price
                    row[19] = ""; // Lineitem compare at price
                    row[20] = product.productCode; // Lineitem sku
                    row[21] = "TRUE"; // Lineitem requires shipping
                    row[22] = "FALSE"; // Lineitem taxable
                    row[23] = "fulfilled"; // Lineitem fulfillment status
                    
                    // Billing/Shipping info - first row only
                    if (productIndex === 0) {
                        const customerName = customerMappings.get(order.customerCode) || order.customerName;
                        row[24] = `${customerName} (${order.customerCode})`; // Billing Name
                        row[25] = "Address Line 1"; // Billing Street
                        row[26] = "Address Line 1"; // Billing Address1
                        row[27] = ""; // Billing Address2
                        row[28] = ""; // Billing Company
                        row[29] = "London"; // Billing City
                        row[30] = "SW1A 0AA"; // Billing Zip
                        row[31] = "ENG"; // Billing Province
                        row[32] = "GB"; // Billing Country
                        row[33] = ""; // Billing Phone
                        
                        // Shipping same as billing
                        row[34] = row[24]; // Shipping Name
                        row[35] = row[25]; // Shipping Street
                        row[36] = row[26]; // Shipping Address1
                        row[37] = ""; // Shipping Address2
                        row[38] = ""; // Shipping Company
                        row[39] = row[29]; // Shipping City
                        row[40] = row[30]; // Shipping Zip
                        row[41] = "ENG"; // Shipping Province
                        row[42] = "GB"; // Shipping Country
                        row[43] = ""; // Shipping Phone
                    }
                    
                    row[44] = productIndex === 0 ? "" : `mw-delivery-date: ${order.deliveryDate.split('/').reverse().join('-')}`; // Notes
                    row[45] = order.deliveryDate; // Note Attributes
                    row[46] = ""; // Cancelled at
                    row[47] = "custom"; // Payment Method
                    row[48] = ""; // Payment Reference
                    row[49] = "0"; // Refunded Amount
                    row[50] = "Osolocal2U"; // Vendor
                    row[51] = productIndex === 0 ? order.total : ""; // Outstanding Balance
                    row[52] = ""; // Employee
                    row[53] = "Unit 2 Horner House"; // Location
                    row[54] = ""; // Device ID
                    row[55] = `1.207${String(Math.floor(Math.random() * 100000)).padStart(5, '0')}E+13`; // Id
                    row[56] = "checkout-by-draft"; // Tags
                    row[57] = "Low"; // Risk Level
                    row[58] = "shopify_draft_order"; // Source
                    row[59] = ""; // Lineitem discount
                    
                    // Tax columns - all empty
                    for (let i = 60; i <= 69; i++) {
                        row[i] = "";
                    }
                    
                    row[70] = ""; // Phone
                    row[71] = ""; // Receipt Number
                    row[72] = ""; // Duties
                    row[73] = "England"; // Billing Province Name
                    row[74] = "England"; // Shipping Province Name
                    row[75] = ""; // Payment ID
                    row[76] = ""; // Payment Terms Name
                    row[77] = ""; // Next Payment Due At
                    row[78] = ""; // Payment References
                    
                    wsData.push(row);
                }
            }
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            
            // Generate filename with current date
            const today = new Date().toISOString().split('T')[0];
            const filename = `freshware_orders_${today}.xlsx`;
            
            XLSX.writeFile(wb, filename);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
