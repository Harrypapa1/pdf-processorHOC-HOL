<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Order Processing System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .nav-link {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            text-decoration: none;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) translateX(-5px);
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            border: 3px dashed #e3e8ef;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-section.dragover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-text h3 {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-text p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .info-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border-left: 5px solid #27ae60;
            text-align: center;
        }
        
        .info-section h3 {
            color: #27ae60;
            margin-bottom: 15px;
        }
        
        .info-section p {
            color: #2c3e50;
            line-height: 1.6;
            margin: 5px 0;
        }
        
        .info-section a {
            color: #27ae60;
            text-decoration: none;
            font-weight: 600;
        }
        
        .info-section a:hover {
            text-decoration: underline;
        }
        
        .processing-section {
            display: none;
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: #e3e8ef;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* New Two-Column Layout */
        .pdf-viewer-section {
            display: none;
            margin: 30px 0;
        }
        
        .viewer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }
        
        .pdf-viewer {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .pdf-viewer-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e3e8ef;
            text-align: center;
        }
        
        .pdf-viewer-header h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .pdf-canvas-container {
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pdf-canvas {
            max-width: 100%;
            max-height: 600px;
            border: 1px solid #e3e8ef;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .pdf-controls {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e3e8ef;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .pdf-control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .pdf-control-btn:hover {
            background: #5a67d8;
        }
        
        .pdf-control-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        .page-info {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .extracted-data {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .extracted-data-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e3e8ef;
        }
        
        .extracted-data-header h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .edit-toggle-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .edit-toggle-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .edit-toggle-btn.editing {
            background: #27ae60;
        }
        
        .edit-toggle-btn.editing:hover {
            background: #229954;
        }
        
        .editable-field {
            background: transparent;
            border: 1px solid transparent;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .editable-field:focus {
            outline: none;
            border-color: #3498db;
            background: #f8fafc;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .editable-field.editing {
            border-color: #e3e8ef;
            background: white;
        }
        
        .editable-cell {
            position: relative;
        }
        
        .editable-cell input {
            border: 1px solid transparent;
            background: transparent;
            padding: 2px 5px;
            border-radius: 3px;
            width: 100%;
            font-family: inherit;
            font-size: inherit;
        }
        
        .editable-cell input:focus {
            outline: none;
            border-color: #3498db;
            background: #f8fafc;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .editable-cell.editing input {
            border-color: #e3e8ef;
            background: white;
        }
        
        .save-changes-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .save-changes-btn:hover {
            background: #229954;
            transform: translateY(-1px);
        }
        
        .changes-indicator {
            color: #e67e22;
            font-weight: bold;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .order-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .extracted-data-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            max-height: 600px;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .products-table th,
        .products-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #e3e8ef;
            font-size: 0.85rem;
        }
        
        .products-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .results-section {
            display: none;
            margin: 30px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .export-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 30px 0;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        .multi-file-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .file-tab {
            background: #e3e8ef;
            color: #2c3e50;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-tab.active {
            background: #667eea;
            color: white;
        }
        
        .file-tab:hover {
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .viewer-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .nav-link {
                position: static;
                transform: none;
                display: inline-block;
                margin-bottom: 15px;
            }
            
            .header {
                text-align: left;
            }
            
            .order-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/customer-email-management.html" class="nav-link">Manage Emails ‚Üí</a>
            <h1>üìß Email Order Processing</h1>
            <p>Transform PDF orders into Excel files for Freshware</p>
        </div>
        
        <div class="main-content">
            <!-- File Upload Section -->
            <div class="upload-section" id="uploadArea">
                <div class="upload-icon">üìé</div>
                <div class="upload-text">
                    <h3>Drop PDF files here or click to browse</h3>
                    <p>Support for consolidated and standard purchase orders</p>
                </div>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Choose Files
                </button>
            </div>

            <!-- Information Section -->
            <div class="info-section">
                <h3>üîß Customer Email Setup Required</h3>
                <p>Before processing orders, make sure customer email mappings are configured.</p>
                <p>Click <a href="/customer-email-management.html">Manage Emails</a> to set up customer email addresses for order notifications.</p>
            </div>
            
            <!-- Processing Section -->
            <div class="processing-section" id="processingSection">
                <h3>üîÑ Processing Orders...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="processingStatus">Initializing...</p>
            </div>
            
            <!-- PDF Viewer Section -->
            <div class="pdf-viewer-section" id="pdfViewerSection">
                <div class="multi-file-tabs" id="fileTabsContainer"></div>
                
                <div class="viewer-container">
                    <!-- PDF Viewer -->
                    <div class="pdf-viewer">
                        <div class="pdf-viewer-header">
                            <h3 id="currentFileName">PDF Document</h3>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Original order document</p>
                        </div>
                        <div class="pdf-canvas-container">
                            <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
                        </div>
                        <div class="pdf-controls">
                            <button class="pdf-control-btn" id="prevPageBtn">‚Üê Previous</button>
                            <span class="page-info" id="pageInfo">Page 1 of 1</span>
                            <button class="pdf-control-btn" id="nextPageBtn">Next ‚Üí</button>
                            <button class="pdf-control-btn" onclick="zoomOut()">Zoom -</button>
                            <button class="pdf-control-btn" onclick="zoomIn()">Zoom +</button>
                        </div>
                    </div>
                    
                    <!-- Extracted Data -->
                    <div class="extracted-data">
                        <div class="extracted-data-header">
                            <div>
                                <h3>üìä Extracted Order Data</h3>
                                <div class="order-summary" id="orderSummary">
                                    <div><strong>Type:</strong> <span id="orderType">-</span></div>
                                    <div><strong>PO Number:</strong> <input class="editable-field" id="orderPO" value="-" onchange="markAsChanged()" disabled></div>
                                    <div><strong>Customer:</strong> <span id="orderCustomer">-</span></div>
                                    <div><strong>Order Date:</strong> <input class="editable-field" id="orderDate" type="date" onchange="markAsChanged()" disabled></div>
                                    <div><strong>Delivery Date:</strong> <input class="editable-field" id="deliveryDate" type="date" onchange="markAsChanged()" disabled></div>
                                    <div><strong>Total:</strong> <span id="orderTotal">¬£0.00</span></div>
                                </div>
                                <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 10px;">
                                    üí° Click "Edit Data" to modify PO number, dates, quantities, and SKU codes<br>
                                    üì¶ SKU suffixes: Case contains "kg" ‚Üí +K, "box" ‚Üí +B, otherwise ‚Üí +E
                                </div>
                            </div>
                            <div>
                                <button class="edit-toggle-btn" id="editToggleBtn" onclick="toggleEditMode()">
                                    ‚úèÔ∏è Edit Data
                                </button>
                                <button class="save-changes-btn" id="saveChangesBtn" onclick="saveChanges()" style="display: none;">
                                    üíæ Save Changes
                                </button>
                                <span class="changes-indicator" id="changesIndicator" style="display: none;">‚óè Changes made</span>
                            </div>
                        </div>
                        <div class="extracted-data-body">
                            <table class="products-table" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>Qty <span style="color: #3498db; font-size: 0.7rem;">‚úèÔ∏è</span></th>
                                        <th>Description</th>
                                        <th>SKU <span style="color: #3498db; font-size: 0.7rem;">‚úèÔ∏è</span></th>
                                        <th>Case</th>
                                        <th>Unit ¬£</th>
                                        <th>Net ¬£</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: #7f8c8d; padding: 40px;">
                                            Upload a PDF to see extracted product data
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Summary Section -->
            <div class="results-section" id="resultsSection">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Orders Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">Products Found</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="mappedProducts">0</div>
                        <div class="stat-label">Mapped Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalValue">¬£0</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                </div>
                
                <!-- Export Section -->
                <div class="export-section">
                    <h3>üìä Ready to Export</h3>
                    <p>All orders have been processed and are ready for Freshware import</p>
                    <button class="btn btn-success" onclick="exportToExcel()">
                        Download Excel File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDeNUflDD7eEiZS9ZE5Z1WwiAMP8Nx4krY",
            authDomain: "email-order-system.firebaseapp.com",
            projectId: "email-order-system",
            storageBucket: "email-order-system.firebasestorage.app",
            messagingSenderId: "148310260005",
            appId: "1:148310260005:web:65014f7b35ebd7e46ec2cc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let processedOrders = [];
        let customerMappings = new Map();
        let productMappings = new Map();
        let emailMappingsCache = new Map();
        let lastCacheUpdate = 0;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // PDF Viewer variables
        let currentPDF = null;
        let currentPage = 1;
        let totalPages = 1;
        let currentScale = 1.2;
        let pdfFiles = [];
        let currentFileIndex = 0;

        // Edit mode variables
        let isEditMode = false;
        let hasUnsavedChanges = false;

        // Vendor mappings by product type
        let vendorMappings = new Map();
        
        function initializeVendorMappings() {
            // Frozen products = CoolFoodGroupMaster
            vendorMappings.set('YRASB', 'CoolFoodGroupMaster'); // Frozen Raspberries
            vendorMappings.set('YBLUB', 'CoolFoodGroupMaster'); // Frozen Blueberries  
            vendorMappings.set('YSFB', 'CoolFoodGroupMaster');  // Frozen Summer Fruits
            vendorMappings.set('YCHERB', 'CoolFoodGroupMaster'); // Frozen Cherries
            
            // Add more frozen product codes as needed
            // Any product starting with 'Y' might be frozen, but we'll map specific ones
            
            // Fresh products = Osolocal2U (default for everything else)
        }

        function getVendorForProduct(productCode) {
            return vendorMappings.get(productCode) || 'Osolocal2U';
        }

        // Get SKU suffix based on case size for Freshware
        function getSKUSuffix(caseSize) {
            if (!caseSize) return 'E'; // Default to EACH if no case size
            
            const caseLower = caseSize.toLowerCase();
            
            if (caseLower.includes('kg') || caseLower.includes('kilo')) {
                return 'K';
            } else if (caseLower.includes('box') || caseLower.includes('bx')) {
                return 'B';
            } else {
                return 'E'; // Default to EACH for everything else (including "each", "1x", etc.)
            }
        }

        // Firebase Functions
        async function loadCustomerEmailsFromFirestore() {
            try {
                console.log('Loading customer emails from Firestore...');
                
                const snapshot = await db.collection('customerEmails').get();
                
                emailMappingsCache.clear();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Store both original and uppercase versions for case-insensitive lookup
                    emailMappingsCache.set(data.customerCode, data.email);
                    emailMappingsCache.set(data.customerCode.toUpperCase(), data.email);
                    if (data.customerName) {
                        emailMappingsCache.set(data.customerName, data.email);
                        emailMappingsCache.set(data.customerName.toUpperCase(), data.email);
                    }
                });
                
                lastCacheUpdate = Date.now();
                console.log(`Loaded ${emailMappingsCache.size} customer email mappings`);
                
                return emailMappingsCache;
            } catch (error) {
                console.error('Error loading customer emails:', error);
                return emailMappingsCache;
            }
        }

        async function getCustomerEmail(customerCode, customerName) {
            if (Date.now() - lastCacheUpdate > CACHE_DURATION) {
                await loadCustomerEmailsFromFirestore();
            }
            
            // Try exact match first, then uppercase versions
            return emailMappingsCache.get(customerCode) || 
                   emailMappingsCache.get(customerCode.toUpperCase()) ||
                   emailMappingsCache.get(customerName) || 
                   emailMappingsCache.get(customerName.toUpperCase()) ||
                   '';
        }
        
        // Initialize known mappings
        async function initializeMappings() {
            // Customer mappings
            customerMappings.set('07BELLA', 'BELLA_KITCHEN');
            customerMappings.set('13RREST', 'RIVER_KITCHEN');
            customerMappings.set('92TABLE', 'TABLE_KITCHEN');
            customerMappings.set('76RICH', 'RICHMOND_HOUSE');
            
            // Product mappings
            productMappings.set('AVO', 'AVOCADO_PEAR');
            productMappings.set('KI', 'KIWI_FRUIT');
            productMappings.set('PINL', 'PINEAPPLE_LARGE');
            productMappings.set('CAU', 'CAULIFLOWER');
            productMappings.set('PLUR', 'PLUMS');
            productMappings.set('SAT', 'SATSUMAS');
            productMappings.set('STR', 'STRAWBERRIES');
            productMappings.set('CEL', 'CELERY');
            productMappings.set('GRBS', 'GRAPES_BLACK'); 
            productMappings.set('GRWS', 'GRAPES_WHITE');
            productMappings.set('POSW', 'POTATO_SWEET');

            // Initialize vendor mappings
            initializeVendorMappings();

            // Load email mappings from Firestore
            await loadCustomerEmailsFromFirestore();
        }
        
        // Initialize the application
        async function init() {
            await initializeMappings();
            setupEventListeners();
            setupPDFControls();
            console.log('App initialized successfully');
        }
        
        // Setup event listeners
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // File input change
            fileInput.addEventListener('change', handleFiles);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                const pdfFiles = files.filter(f => 
                    f.type === 'application/pdf' || 
                    f.name.toLowerCase().endsWith('.pdf')
                );
                
                if (pdfFiles.length > 0) {
                    processFiles(pdfFiles);
                } else {
                    alert('Please drop PDF files only.');
                }
            });
            
            uploadArea.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    fileInput.click();
                }
            });
        }
        
        // Setup PDF Controls
        function setupPDFControls() {
            document.getElementById('prevPageBtn').addEventListener('click', prevPage);
            document.getElementById('nextPageBtn').addEventListener('click', nextPage);
        }
        
        // Handle file selection
        function handleFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                processFiles(files);
            }
        }
        
        // Process PDF files
        async function processFiles(files) {
            document.getElementById('processingSection').style.display = 'block';
            document.getElementById('pdfViewerSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            processedOrders = [];
            pdfFiles = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateProgress((i / files.length) * 100, `Processing ${file.name}...`);
                
                try {
                    const order = await processPDF(file);
                    if (order) {
                        processedOrders.push(order);
                        pdfFiles.push({
                            file: file,
                            order: order,
                            pdf: null // Will be loaded when viewed
                        });
                    }
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    alert(`Error processing ${file.name}: ${error.message}`);
                }
            }
            
            updateProgress(100, 'Processing complete!');
            setTimeout(() => {
                document.getElementById('processingSection').style.display = 'none';
                displayPDFViewer();
                displayResults();
            }, 1000);
        }
        
        // Display PDF Viewer
        async function displayPDFViewer() {
            if (pdfFiles.length === 0) return;
            
            document.getElementById('pdfViewerSection').style.display = 'block';
            
            // Create file tabs
            const tabsContainer = document.getElementById('fileTabsContainer');
            tabsContainer.innerHTML = '';
            
            pdfFiles.forEach((pdfFile, index) => {
                const tab = document.createElement('button');
                tab.className = `file-tab ${index === 0 ? 'active' : ''}`;
                tab.textContent = pdfFile.file.name;
                tab.onclick = () => switchToFile(index);
                tabsContainer.appendChild(tab);
            });
            
            // Load first PDF
            currentFileIndex = 0;
            await loadPDFForViewing(0);
        }
        
        // Switch to different file
        async function switchToFile(index) {
            // Check for unsaved changes
            if (hasUnsavedChanges) {
                const confirmSwitch = confirm('You have unsaved changes. Do you want to save them before switching files?\n\nClick OK to save, or Cancel to discard changes.');
                if (confirmSwitch) {
                    saveChanges();
                } else {
                    // Discard changes by reloading the current file
                    hasUnsavedChanges = false;
                    updateEditModeUI();
                }
            }
            
            // Update active tab
            document.querySelectorAll('.file-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            currentFileIndex = index;
            await loadPDFForViewing(index);
        }
        
        // Load PDF for viewing
        async function loadPDFForViewing(index) {
            const pdfFile = pdfFiles[index];
            
            try {
                if (!pdfFile.pdf) {
                    const arrayBuffer = await pdfFile.file.arrayBuffer();
                    pdfFile.pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                }
                
                currentPDF = pdfFile.pdf;
                totalPages = currentPDF.numPages;
                currentPage = 1;
                
                // Update filename display
                document.getElementById('currentFileName').textContent = pdfFile.file.name;
                
                // Render first page
                await renderPage(1);
                
                // Update extracted data display
                updateExtractedDataDisplay(pdfFile.order);
                
                // Reset edit mode for new file
                isEditMode = false;
                hasUnsavedChanges = false;
                updateEditModeUI();
                
            } catch (error) {
                console.error('Error loading PDF for viewing:', error);
            }
        }
        
        // Render PDF page
        async function renderPage(pageNum) {
            if (!currentPDF) return;
            
            try {
                const page = await currentPDF.getPage(pageNum);
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                
                const viewport = page.getViewport({ scale: currentScale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                // Update page info
                document.getElementById('pageInfo').textContent = `Page ${pageNum} of ${totalPages}`;
                
                // Update button states
                document.getElementById('prevPageBtn').disabled = pageNum <= 1;
                document.getElementById('nextPageBtn').disabled = pageNum >= totalPages;
                
            } catch (error) {
                console.error('Error rendering page:', error);
            }
        }
        
        // PDF Navigation
        function prevPage() {
            if (currentPage <= 1) return;
            currentPage--;
            renderPage(currentPage);
        }
        
        function nextPage() {
            if (currentPage >= totalPages) return;
            currentPage++;
            renderPage(currentPage);
        }
        
        function zoomIn() {
            currentScale = Math.min(currentScale * 1.2, 3.0);
            renderPage(currentPage);
        }
        
        function zoomOut() {
            currentScale = Math.max(currentScale / 1.2, 0.5);
            renderPage(currentPage);
        }
        
        // Update extracted data display
        function updateExtractedDataDisplay(order) {
            // Update order summary
            document.getElementById('orderType').textContent = order.type;
            document.getElementById('orderPO').value = order.poNumber || '';
            document.getElementById('orderCustomer').textContent = `${order.customerName} (${order.customerCode})`;
            
            // Convert dates from DD/MM/YYYY to YYYY-MM-DD for date inputs
            document.getElementById('orderDate').value = convertDateForInput(order.orderDate);
            document.getElementById('deliveryDate').value = convertDateForInput(order.deliveryDate);
            document.getElementById('orderTotal').textContent = `¬£${order.total.toFixed(2)}`;
            
            // Update products table
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            if (order.products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #7f8c8d; padding: 40px;">
                            No products found in this order
                        </td>
                    </tr>
                `;
            } else {
                order.products.forEach((product, index) => {
                    const skuWithSuffix = product.productCode + getSKUSuffix(product.caseSize);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="editable-cell">
                            <input type="number" step="0.1" value="${product.quantity}" 
                                   onchange="updateProductField(${index}, 'quantity', this.value)" />
                        </td>
                        <td>${product.description}</td>
                        <td class="editable-cell">
                            <input type="text" value="${product.productCode}" 
                                   onchange="updateProductField(${index}, 'productCode', this.value)" 
                                   style="text-transform: uppercase;" />
                            <div style="font-size: 0.7rem; color: #3498db; margin-top: 2px;">
                                Export: ${skuWithSuffix}
                            </div>
                        </td>
                        <td>${product.caseSize}</td>
                        <td>¬£${product.unitPrice.toFixed(2)}</td>
                        <td>¬£${product.netPrice.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Reset edit mode
            isEditMode = false;
            hasUnsavedChanges = false;
            updateEditModeUI();
        }
        
        // Convert date from DD/MM/YYYY to YYYY-MM-DD
        function convertDateForInput(dateStr) {
            if (!dateStr || dateStr === '') return '';
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr;
        }
        
        // Convert date from YYYY-MM-DD to DD/MM/YYYY
        function convertDateFromInput(dateStr) {
            if (!dateStr || dateStr === '') return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return dateStr;
        }
        
        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            updateEditModeUI();
        }
        
        // Update UI based on edit mode
        function updateEditModeUI() {
            const editBtn = document.getElementById('editToggleBtn');
            const saveBtn = document.getElementById('saveChangesBtn');
            const changesIndicator = document.getElementById('changesIndicator');
            const editableFields = document.querySelectorAll('.editable-field');
            const editableCells = document.querySelectorAll('.editable-cell');
            
            if (isEditMode) {
                editBtn.textContent = 'üëÅÔ∏è View Mode';
                editBtn.classList.add('editing');
                saveBtn.style.display = hasUnsavedChanges ? 'inline-block' : 'none';
                
                // Enable editing
                editableFields.forEach(field => {
                    field.classList.add('editing');
                    field.disabled = false;
                });
                
                editableCells.forEach(cell => {
                    cell.classList.add('editing');
                    const input = cell.querySelector('input');
                    if (input) input.disabled = false;
                });
            } else {
                editBtn.textContent = '‚úèÔ∏è Edit Data';
                editBtn.classList.remove('editing');
                saveBtn.style.display = 'none';
                
                // Disable editing
                editableFields.forEach(field => {
                    field.classList.remove('editing');
                    field.disabled = true;
                });
                
                editableCells.forEach(cell => {
                    cell.classList.remove('editing');
                    const input = cell.querySelector('input');
                    if (input) input.disabled = true;
                });
            }
            
            // Show/hide changes indicator
            changesIndicator.style.display = hasUnsavedChanges ? 'inline' : 'none';
        }
        
        // Mark as changed
        function markAsChanged() {
            hasUnsavedChanges = true;
            updateEditModeUI();
        }
        
        // Update product field
        function updateProductField(productIndex, field, value) {
            if (currentFileIndex >= 0 && currentFileIndex < pdfFiles.length) {
                const order = pdfFiles[currentFileIndex].order;
                if (productIndex >= 0 && productIndex < order.products.length) {
                    if (field === 'quantity') {
                        const newQuantity = parseFloat(value) || 0;
                        order.products[productIndex].quantity = newQuantity;
                        // Recalculate net price
                        order.products[productIndex].netPrice = newQuantity * order.products[productIndex].unitPrice;
                        
                        // Update the net price display immediately
                        const row = document.querySelector(`#productsTableBody tr:nth-child(${productIndex + 1})`);
                        if (row) {
                            const netCell = row.querySelector('td:last-child');
                            if (netCell) {
                                netCell.textContent = `¬£${order.products[productIndex].netPrice.toFixed(2)}`;
                            }
                        }
                        
                        // Recalculate order total
                        order.total = order.products.reduce((sum, product) => sum + product.netPrice, 0);
                        document.getElementById('orderTotal').textContent = `¬£${order.total.toFixed(2)}`;
                        
                    } else if (field === 'productCode') {
                        order.products[productIndex].productCode = value.toUpperCase();
                        
                        // Update the export SKU display immediately
                        const row = document.querySelector(`#productsTableBody tr:nth-child(${productIndex + 1})`);
                        if (row) {
                            const skuCell = row.querySelector('td:nth-child(3)');
                            if (skuCell) {
                                const exportDiv = skuCell.querySelector('div');
                                if (exportDiv) {
                                    const skuWithSuffix = order.products[productIndex].productCode + getSKUSuffix(order.products[productIndex].caseSize);
                                    exportDiv.textContent = `Export: ${skuWithSuffix}`;
                                }
                            }
                        }
                    }
                    
                    // Update processed orders array
                    const processedOrderIndex = processedOrders.findIndex(o => o.filename === order.filename);
                    if (processedOrderIndex >= 0) {
                        processedOrders[processedOrderIndex] = order;
                    }
                    
                    markAsChanged();
                }
            }
        }
        
        // Save changes
        function saveChanges() {
            if (currentFileIndex >= 0 && currentFileIndex < pdfFiles.length) {
                const order = pdfFiles[currentFileIndex].order;
                
                // Update order data from form fields
                order.poNumber = document.getElementById('orderPO').value;
                order.orderDate = convertDateFromInput(document.getElementById('orderDate').value);
                order.deliveryDate = convertDateFromInput(document.getElementById('deliveryDate').value);
                
                // Update processed orders array
                const processedOrderIndex = processedOrders.findIndex(o => o.filename === order.filename);
                if (processedOrderIndex >= 0) {
                    processedOrders[processedOrderIndex] = order;
                }
                
                // Update display with new data
                updateExtractedDataDisplay(order);
                
                hasUnsavedChanges = false;
                updateEditModeUI();
                
                alert('‚úÖ Changes saved successfully!');
                
                // Update summary stats
                displayResults();
            }
        }
        
        // Real PDF processing with PDF.js
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                
                // Extract text from PDF
                const text = textContent.items.map(item => item.str).join(' ');
                
                // Determine template type and parse
                const isConsolidated = text.includes('Consolidated Purchase Order');
                
                if (isConsolidated) {
                    return parseConsolidatedOrder(text, file.name);
                } else {
                    return parseStandardOrder(text, file.name);
                }
            } catch (error) {
                console.error('Error processing PDF:', error);
                throw error;
            }
        }
        
        // Parse consolidated order template
        function parseConsolidatedOrder(text, filename) {
            const order = {
                filename: filename,
                type: 'Consolidated',
                customerCode: '',
                customerName: '',
                poNumber: '',
                orderDate: '',
                deliveryDate: '',
                products: [],
                total: 0
            };
            
            // Extract PO Number
            const poPatterns = [
                /PO Number:\s*([A-Z0-9]+)/i,
                /Purchase Order[^:]*:\s*([A-Z0-9]+)/i,
                /PO[:\s]+([A-Z0-9]+)/i
            ];
            
            for (const pattern of poPatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.poNumber = match[1];
                    break;
                }
            }
            
            // Extract dates
            const orderDatePatterns = [
                /Order Date:\s*(\d{2}\/\d{2}\/\d{4})/,
                /Date:\s*(\d{2}\/\d{2}\/\d{4})/
            ];
            
            for (const pattern of orderDatePatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.orderDate = match[1];
                    break;
                }
            }
            
            const deliveryDatePatterns = [
                /Delivery Date:\s*(\d{2}\/\d{2}\/\d{4})/,
                /Deliver[^:]*:\s*(\d{2}\/\d{2}\/\d{4})/
            ];
            
            for (const pattern of deliveryDatePatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.deliveryDate = match[1];
                    break;
                }
            }
            
            // Extract customer info
            const customerPatterns = [
                /following outlets[^:]*:\s*([^(]+)\s*\(([^)]+)\)/i,
                /outlets[^:]*:\s*([^(]+)\s*\(([^)]+)\)/i,
                /The\s+([^(]+)\s*\(([^)]+)\)/i
            ];
            
            for (const pattern of customerPatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.customerName = match[1].trim();
                    order.customerCode = match[2].trim();
                    break;
                }
            }
            
            // Extract products
            const productPatterns = [
                /(\d+\.?\d*)\s+([A-Z\s]+?)\s+([A-Z]+)\s+(1x[A-Za-z]+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g,
                /(\d+\.?\d*)\s+([A-Z][A-Z\s]+?)\s+([A-Z]{2,5})\s+([^\d]+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g
            ];
            
            for (const pattern of productPatterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const product = {
                        quantity: parseFloat(match[1]),
                        description: match[2].trim(),
                        productCode: match[3].trim(),
                        caseSize: match[4].trim(),
                        unitPrice: parseFloat(match[5]),
                        netPrice: parseFloat(match[6])
                    };
                    
                    if (product.quantity > 0 && product.productCode && product.unitPrice > 0) {
                        order.products.push(product);
                        order.total += product.netPrice;
                    }
                }
                
                if (order.products.length > 0) break;
            }
            
            // Extract total if products parsing failed
            if (order.total === 0) {
                const totalPatterns = [
                    /Net Total[:\s]+(\d+\.?\d*)/i,
                    /Total[:\s]+(\d+\.?\d*)/i
                ];
                
                for (const pattern of totalPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        order.total = parseFloat(match[1]);
                        break;
                    }
                }
            }
            
            return order;
        }
        
        // Parse standard order template  
        function parseStandardOrder(text, filename) {
            const order = {
                filename: filename,
                type: 'Standard',
                customerCode: '',
                customerName: '',
                poNumber: '',
                orderDate: '',
                deliveryDate: '',
                products: [],
                total: 0
            };
            
            // Extract PO Number
            const poMatch = text.match(/PO Number:\s*([A-Z0-9]+)/);
            if (poMatch) order.poNumber = poMatch[1];
            
            // Extract dates
            const orderDateMatch = text.match(/Order Date:\s*(\d{2}\/\d{2}\/\d{4})/);
            if (orderDateMatch) order.orderDate = orderDateMatch[1];
            
            const deliveryDateMatch = text.match(/Delivery Date:\s*(\d{2}\/\d{2}\/\d{4})/);
            if (deliveryDateMatch) order.deliveryDate = deliveryDateMatch[1];
            
            // Extract customer code from Account No
            const accountMatch = text.match(/Account No:\s*([A-Z0-9]+)/);
            if (accountMatch) order.customerCode = accountMatch[1];
            
            // Extract customer name from Deliver To section
            const deliverMatch = text.match(/Deliver To\s+([^\n]+)/);
            if (deliverMatch) order.customerName = deliverMatch[1].trim();
            
            // Extract products table
            const tablePattern = /(\d+\.?\d*)\s+([A-Z\s]+?)\s+([A-Z]+)\s+(1x\w+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g;
            let match;
            
            while ((match = tablePattern.exec(text)) !== null) {
                const product = {
                    quantity: parseFloat(match[1]),
                    description: match[2].trim(),
                    productCode: match[3].trim(),
                    caseSize: match[4].trim(),
                    unitPrice: parseFloat(match[5]),
                    netPrice: parseFloat(match[6])
                };
                order.products.push(product);
                order.total += product.netPrice;
            }
            
            return order;
        }
        
        // Update progress bar
        function updateProgress(percent, status) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('processingStatus').textContent = status;
        }
        
        // Display processing results
        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            
            // Update stats
            const totalProducts = processedOrders.reduce((sum, order) => sum + order.products.length, 0);
            const totalValue = processedOrders.reduce((sum, order) => sum + order.total, 0);
            
            document.getElementById('totalOrders').textContent = processedOrders.length;
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('mappedProducts').textContent = totalProducts;
            document.getElementById('totalValue').textContent = '¬£' + totalValue.toFixed(2);
            
            resultsSection.style.display = 'block';
        }
        
        // Export to Excel in Freshware format with email lookup
        async function exportToExcel() {
            // First, validate that all customers have email mappings
            const missingEmails = [];
            
            for (const order of processedOrders) {
                const customerEmail = await getCustomerEmail(order.customerCode, order.customerName);
                if (!customerEmail || customerEmail.trim() === '') {
                    missingEmails.push({
                        customerCode: order.customerCode,
                        customerName: order.customerName,
                        filename: order.filename
                    });
                }
            }
            
            // If any emails are missing, show alert and stop export
            if (missingEmails.length > 0) {
                let alertMessage = '‚ùå Cannot export! Missing customer email mappings:\n\n';
                
                missingEmails.forEach(missing => {
                    alertMessage += `‚Ä¢ ${missing.customerCode} (${missing.customerName}) - from ${missing.filename}\n`;
                });
                
                alertMessage += '\nüîß Please add these email mappings first:\n';
                alertMessage += '1. Click "Manage Emails ‚Üí" in the top right\n';
                alertMessage += '2. Add the missing customer emails\n';
                alertMessage += '3. Return here and export again\n\n';
                alertMessage += 'Export cancelled - no file was created.';
                
                alert(alertMessage);
                return; // Stop the export process
            }
            
            const wb = XLSX.utils.book_new();
            const wsData = [];
            
            // Add header row
            const headers = [
                "Name", "Email", "Financial Status", "Paid at", "Fulfillment Status", "Fulfilled at",
                "Accepts Marketing", "Currency", "Subtotal", "Shipping", "Taxes", "Total", 
                "Discount Code", "Discount Amount", "Shipping Method", "Created at", 
                "Lineitem quantity", "Lineitem name", "Lineitem price", "Lineitem compare at price",
                "Lineitem sku", "Lineitem requires shipping", "Lineitem taxable", "Lineitem fulfillment status",
                "Billing Name", "Billing Street", "Billing Address1", "Billing Address2", "Billing Company",
                "Billing City", "Billing Zip", "Billing Province", "Billing Country", "Billing Phone",
                "Shipping Name", "Shipping Street", "Shipping Address1", "Shipping Address2", "Shipping Company",
                "Shipping City", "Shipping Zip", "Shipping Province", "Shipping Country", "Shipping Phone",
                "Notes", "Note Attributes", "Cancelled at", "Payment Method", "Payment Reference",
                "Refunded Amount", "Vendor", "Outstanding Balance", "Employee", "Location", "Device ID",
                "Id", "Tags", "Risk Level", "Source", "Lineitem discount", "Tax 1 Name", "Tax 1 Value",
                "Tax 2 Name", "Tax 2 Value", "Tax 3 Name", "Tax 3 Value", "Tax 4 Name", "Tax 4 Value",
                "Tax 5 Name", "Tax 5 Value", "Phone", "Receipt Number", "Duties", "Billing Province Name",
                "Shipping Province Name", "Payment ID", "Payment Terms Name", "Next Payment Due At", "Payment References"
            ];
            wsData.push(headers);
            
            // Add data rows with email lookup
            for (const order of processedOrders) {
                // Get customer email from Firebase
                const customerEmail = await getCustomerEmail(order.customerCode, order.customerName);
                
                for (let productIndex = 0; productIndex < order.products.length; productIndex++) {
                    const product = order.products[productIndex];
                    const row = new Array(79).fill("");
                    
                    // Column A (Name) = Purchase Order Number from PDF (NOT generated ID)
                    row[0] = order.poNumber || `PO-${order.customerCode}-${order.orderDate}`; // Name - PO Number
                    row[1] = customerEmail; // Email - FROM FIREBASE!
                    
                    // Order-level data ONLY on first line item
                    if (productIndex === 0) {
                        row[2] = "pending"; // Financial Status
                        row[4] = "fulfilled"; // Fulfillment Status
                        row[5] = `${order.deliveryDate.split('/').reverse().join('-')} 21:21:42 +0100`; // Fulfilled at
                        row[6] = "yes"; // Accepts Marketing
                        row[7] = "GBP"; // Currency
                        row[8] = order.total; // Subtotal
                        row[9] = 0; // Shipping
                        row[10] = 0; // Taxes
                        row[11] = order.total; // Total
                        row[14] = "FREE DELIVERY"; // Shipping Method
                        row[47] = "custom"; // Payment Method
                        row[49] = "0"; // Refunded Amount
                        row[51] = order.total; // Outstanding Balance
                        
                        // Billing/Shipping info - first row only
                        const customerName = customerMappings.get(order.customerCode) || order.customerName;
                        row[24] = `${customerName} (${order.customerCode})`; // Billing Name
                        row[25] = "Address Line 1"; // Billing Street
                        row[26] = "Address Line 1"; // Billing Address1
                        row[29] = "London"; // Billing City
                        row[30] = "SW1A 0AA"; // Billing Zip
                        row[31] = "ENG"; // Billing Province
                        row[32] = "GB"; // Billing Country
                        
                        // Shipping same as billing
                        row[34] = row[24]; // Shipping Name
                        row[35] = row[25]; // Shipping Street
                        row[36] = row[26]; // Shipping Address1
                        row[39] = row[29]; // Shipping City
                        row[40] = row[30]; // Shipping Zip
                        row[41] = "ENG"; // Shipping Province
                        row[42] = "GB"; // Shipping Country
                        
                        // Column AT (index 45) = Note Attributes with delivery date ONLY on first row
                        row[45] = `mw-delivery-date: ${order.deliveryDate.split('/').reverse().join('-')}`; // Note Attributes
                    } else {
                        // Leave order-level fields BLANK for additional line items
                        row[44] = ""; // Notes - empty for additional line items
                        row[45] = ""; // Note Attributes - BLANK on additional rows
                    }
                    
                    // Line item data - appears on ALL rows
                    row[15] = `${order.orderDate.split('/').reverse().join('-')} 20:29:32 +0100`; // Created at
                    row[16] = product.quantity; // Lineitem quantity
                    row[17] = product.description; // Lineitem name
                    row[18] = product.unitPrice; // Lineitem price
                    row[20] = product.productCode + getSKUSuffix(product.caseSize); // Lineitem sku with suffix
                    row[21] = "TRUE"; // Lineitem requires shipping
                    row[22] = "FALSE"; // Lineitem taxable
                    row[23] = "fulfilled"; // Lineitem fulfillment status
                    
                    row[50] = getVendorForProduct(product.productCode); // Vendor (based on product type)
                    row[53] = "Unit 2 Horner House"; // Location
                    row[55] = `1.207${String(Math.floor(Math.random() * 100000)).padStart(5, '0')}E+13`; // Id
                    row[56] = "checkout-by-draft"; // Tags
                    row[57] = "Low"; // Risk Level
                    row[58] = "shopify_draft_order"; // Source
                    
                    // Tax columns and remaining fields - all empty except province names
                    row[73] = "England"; // Billing Province Name
                    row[74] = "England"; // Shipping Province Name
                    
                    wsData.push(row);
                }
            }
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            
            // Generate filename with current date
            const today = new Date().toISOString().split('T')[0];
            const filename = `freshware_orders_${today}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            // Show success message
            alert(`‚úÖ Export successful!\n\nFile: ${filename}\nOrders: ${processedOrders.length}\nTotal Products: ${processedOrders.reduce((sum, order) => sum + order.products.length, 0)}\n\nReady for Freshware import!`);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
