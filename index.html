<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Order Processing System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        
        // Parse standard order template  
        function parseStandardOrder(text, filename) {pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .nav-links {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            color: white;
            text-decoration: none;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            border: 2px dashed #e3e8ef;
            border-radius: 10px;
            padding: 15px 20px;
            text-align: center;
            margin-bottom: 25px;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-section.dragover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .upload-text h3 {
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .upload-text p {
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        
        /* Processing Queue Section */
        .queue-section {
            display: none;
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .queue-header h3 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.3rem;
        }
        
        .queue-count {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .queue-list {
            margin-bottom: 20px;
        }
        
        .queue-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .queue-item-info {
            flex: 1;
        }
        
        .queue-item-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .queue-item-details {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .queue-item-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .btn-remove:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        
        .queue-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-process-all {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-process-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        .btn-clear-queue {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-clear-queue:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(102, 126, 234, 0.3);
        }
        
        .info-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border-left: 5px solid #27ae60;
            text-align: center;
        }
        
        .info-section h3 {
            color: #27ae60;
            margin-bottom: 15px;
        }
        
        .info-section p {
            color: #2c3e50;
            line-height: 1.6;
            margin: 5px 0;
        }
        
        .info-section a {
            color: #27ae60;
            text-decoration: none;
            font-weight: 600;
        }
        
        .info-section a:hover {
            text-decoration: underline;
        }
        
        .processing-section {
            display: none;
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: #e3e8ef;
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Updated PDF Viewer Layout */
        .pdf-viewer-section {
            display: none;
            margin: 30px 0;
        }
        
        .viewer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }
        
        .pdf-viewer {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .pdf-viewer-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e3e8ef;
            text-align: center;
            flex-shrink: 0;
        }
        
        .pdf-viewer-header h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        /* Improved PDF Canvas Container */
        .pdf-canvas-container {
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            min-height: 400px;
            max-height: 80vh;
        }
        
        .pdf-canvas {
            border: 1px solid #e3e8ef;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background: white;
            max-width: 100%;
            height: auto;
        }
        
        /* Enhanced PDF Controls */
        .pdf-controls {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e3e8ef;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .pdf-control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .pdf-control-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .pdf-control-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .pdf-control-btn.active {
            background: #2ecc71;
        }
        
        .page-info {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin: 0 10px;
        }
        
        .zoom-info {
            color: #7f8c8d;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 0 5px;
        }
        
        .extracted-data {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .extracted-data-header {
            background: #f8fafc;
            padding: 20px;
            border-bottom: 1px solid #e3e8ef;
        }
        
        .extracted-data-header h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .edit-toggle-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .edit-toggle-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .edit-toggle-btn.editing {
            background: #27ae60;
        }
        
        .edit-toggle-btn.editing:hover {
            background: #229954;
        }
        
        /* Order Lists Styles */ 
        .approved-orders-list {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
        }
        
        .approved-orders-list h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .approved-order-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid #27ae60;
        }
        
        .approved-order-item .order-item-title {
            color: #27ae60;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .approved-order-item .order-item-details {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .approved-order-item::after {
            content: "✅";
            float: right;
            font-size: 1.2rem;
        }
        
        .approve-order-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .approve-order-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 10px rgba(46, 204, 113, 0.3);
        }
        
        .approve-order-btn.approved {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .approve-order-btn.approved:hover {
            transform: none;
            box-shadow: none;
        }
        
        .editable-field {
            background: transparent;
            border: 1px solid transparent;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .editable-field:focus {
            outline: none;
            border-color: #3498db;
            background: #f8fafc;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .editable-field.editing {
            border-color: #e3e8ef;
            background: white;
        }
        
        .editable-cell {
            position: relative;
        }
        
        .editable-cell input {
            border: 1px solid transparent;
            background: transparent;
            padding: 2px 5px;
            border-radius: 3px;
            width: 100%;
            font-family: inherit;
            font-size: inherit;
        }
        
        .editable-cell select {
            border: 1px solid transparent;
            background: transparent;
            padding: 2px 5px;
            border-radius: 3px;
            width: 100%;
            font-family: inherit;
            font-size: inherit;
        }
        
        .editable-cell input:focus,
        .editable-cell select:focus {
            outline: none;
            border-color: #3498db;
            background: #f8fafc;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .editable-cell.editing input,
        .editable-cell.editing select {
            border-color: #e3e8ef;
            background: white;
        }

        /* Decimal Warning Styles */
        .decimal-warning {
            background: #ffebee !important;
            border-left: 4px solid #f44336 !important;
        }

        .decimal-warning input {
            color: #d32f2f !important;
            font-weight: bold !important;
        }

        /* Successful Conversion Styles */
        .conversion-success {
            background: #f0f8f0 !important;
            border-left: 4px solid #2e7d32 !important;
        }

        .conversion-success input {
            color: #2e7d32 !important;
            font-weight: bold !important;
        }

        .conversion-note {
            font-size: 0.7rem;
            margin-top: 2px;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .conversion-note.converted {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .conversion-note.warning {
            background: #ffebee;
            color: #d32f2f;
            font-weight: bold;
        }
        
        .save-changes-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .save-changes-btn:hover {
            background: #229954;
            transform: translateY(-1px);
        }
        
        .changes-indicator {
            color: #e67e22;
            font-weight: bold;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        /* Order summary moved below products */
        .order-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 0.9rem;
            color: #7f8c8d;
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e3e8ef;
        }
        
        .order-summary-header {
            grid-column: 1 / -1;
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 1px solid #e3e8ef;
            padding-bottom: 10px;
        }
        
        .extracted-data-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            max-height: 600px;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .products-table th,
        .products-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #e3e8ef;
            font-size: 0.85rem;
        }
        
        .products-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .results-section {
            display: none;
            margin: 30px 0;
        }
        
        .export-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 30px 0;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        .multi-file-tabs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .file-tab {
            background: #e3e8ef;
            color: #2c3e50;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-tab.active {
            background: #667eea;
            color: white;
        }
        
        .file-tab.approved {
            background: #27ae60;
            color: white;
            position: relative;
        }
        
        .file-tab.approved::after {
            content: "✅";
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .file-tab:hover {
            transform: translateY(-2px);
        }

        /* Conversion Status Section */
        .conversion-status {
            background: #fff3cd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .conversion-status h4 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .conversion-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.85rem;
        }

        .conversion-stat {
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
        }

        .conversion-stat .number {
            font-weight: bold;
            font-size: 1.2em;
            color: #856404;
        }

        .conversion-stat.warning .number {
            color: #d32f2f;
        }

        .conversion-stat.success .number {
            color: #2e7d32;
        }
        
        /* Duplicate Order Warning */
        .duplicate-warning {
            background: #ffebee;
            border: 3px solid #f44336;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        
        .duplicate-warning h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .duplicate-warning p {
            color: #d32f2f;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .duplicate-warning .po-highlight {
            background: #d32f2f;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        .duplicate-actions {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-skip {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .btn-skip:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }
        
        .btn-process-anyway {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .btn-process-anyway:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .viewer-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .nav-links {
                position: static;
                transform: none;
                display: flex;
                justify-content: center;
                margin-bottom: 15px;
                flex-wrap: wrap;
            }
            
            .header {
                text-align: center;
            }
            
            .order-summary {
                grid-template-columns: 1fr;
            }

            .conversion-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .pdf-controls {
                gap: 5px;
            }
            
            .pdf-control-btn {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .queue-actions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav-links">
                <a href="/customer-email-management.html" class="nav-link">Manage Settings</a>
                <a href="/order-history.html" class="nav-link">Order History</a>
            </div>
            <h1>📧 Email Order Processing</h1>
            <p>Transform PDF orders into Excel files for Freshware</p>
        </div>
        
        <div class="main-content">
            <!-- File Upload Section -->
            <div class="upload-section" id="uploadArea">
                <div class="upload-icon">📎</div>
                <div class="upload-text">
                    <h3>Drop PDF files here or click to browse</h3>
                    <p>Files will be added to the processing queue below</p>
                </div>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Choose Files
                </button>
            </div>

            <!-- Processing Queue Section -->
            <div class="queue-section" id="queueSection">
                <div class="queue-header">
                    <h3>📋 Processing Queue</h3>
                    <span class="queue-count" id="queueCount">0 files</span>
                </div>
                
                <div class="queue-list" id="queueList">
                    <!-- Queue items will be populated here -->
                </div>
                
                <div class="queue-actions">
                    <button class="btn-process-all" id="processAllBtn" onclick="processAllQueuedFiles()">
                        🚀 Process All Orders
                    </button>
                    <button class="btn-clear-queue" onclick="clearQueue()">
                        🗑️ Clear Queue
                    </button>
                </div>
            </div>

            <!-- Processing Section -->
            <div class="processing-section" id="processingSection">
                <h3>🔄 Processing Orders...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="processingStatus">Initializing...</p>
            </div>
            
            <!-- PDF Viewer Section -->
            <div class="pdf-viewer-section" id="pdfViewerSection">
                <div class="multi-file-tabs" id="fileTabsContainer"></div>
                
                <div class="viewer-container">
                    <!-- PDF Viewer -->
                    <div class="pdf-viewer">
                        <div class="pdf-viewer-header">
                            <h3 id="currentFileName">PDF Document</h3>
                            <p style="color: #7f8c8d; font-size: 0.9rem;">Original order document</p>
                        </div>
                        <div class="pdf-canvas-container">
                            <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
                        </div>
                        <div class="pdf-controls">
                            <button class="pdf-control-btn" id="prevPageBtn">← Prev</button>
                            <span class="page-info" id="pageInfo">Page 1 of 1</span>
                            <button class="pdf-control-btn" id="nextPageBtn">Next →</button>
                            <div style="margin: 0 10px; border-left: 1px solid #e3e8ef; height: 20px;"></div>
                            <button class="pdf-control-btn" id="fitWidthBtn">Fit Width</button>
                            <button class="pdf-control-btn" onclick="zoomOut()">Zoom -</button>
                            <span class="zoom-info" id="zoomInfo">100%</span>
                            <button class="pdf-control-btn" onclick="zoomIn()">Zoom +</button>
                        </div>
                    </div>
                    
                    <!-- Extracted Data -->
                    <div class="extracted-data">
                        <div class="extracted-data-header">
                            <div>
                                <h3>📊 Extracted Order Data</h3>
                                <div style="font-size: 0.8rem; color: #7f8c8d; margin-top: 10px;">
                                    💡 Click "Edit Data" to modify PO number, dates, quantities, SKU codes, and case sizes<br>
                                    📦 Decimal quantities are automatically converted using your product settings<br>
                                    🔴 Red highlighting indicates problematic decimals that need attention<br>
                                    📋 Case sizes: Select "Each" (E), "Kilo" (K), or "Box" (B) to control export SKU suffixes
                                </div>
                            </div>
                            <div>
                                <button class="edit-toggle-btn" id="editToggleBtn" onclick="toggleEditMode()">
                                    ✏️ Edit Data
                                </button>
                                <button class="save-changes-btn" id="saveChangesBtn" onclick="saveChanges()" style="display: none;">
                                    💾 Save Changes
                                </button>
                                <span class="changes-indicator" id="changesIndicator" style="display: none;">● Changes made</span>
                            </div>
                        </div>

                        <!-- Conversion Status -->
                        <div class="conversion-status" id="conversionStatus" style="display: none;">
                            <h4>🧮 Decimal Quantity Conversions</h4>
                            <div class="conversion-stats" id="conversionStats">
                                <div class="conversion-stat success">
                                    <div class="number" id="convertedCount">0</div>
                                    <div>Converted</div>
                                </div>
                                <div class="conversion-stat warning">
                                    <div class="number" id="warningCount">0</div>
                                    <div>Need Attention</div>
                                </div>
                                <div class="conversion-stat">
                                    <div class="number" id="wholeCount">0</div>
                                    <div>Whole Numbers</div>
                                </div>
                            </div>
                        </div>

                        <div class="extracted-data-body">
                            <table class="products-table" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>Qty <span style="color: #3498db; font-size: 0.7rem;">✏️</span></th>
                                        <th>Description</th>
                                        <th>SKU <span style="color: #3498db; font-size: 0.7rem;">✏️</span></th>
                                        <th>Case <span style="color: #3498db; font-size: 0.7rem;">✏️</span></th>
                                        <th>Unit £</th>
                                        <th>Net £</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: #7f8c8d; padding: 40px;">
                                            Upload a PDF to see extracted product data
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Order Summary - NOW BELOW PRODUCTS -->
                            <div class="order-summary" id="orderSummary">
                                <div class="order-summary-header">📊 Order Summary</div>
                                <div><strong>Type:</strong> <span id="orderType">-</span></div>
                                <div><strong>PO Number:</strong> <input class="editable-field" id="orderPO" value="-" onchange="markAsChanged()" disabled></div>
                                <div><strong>Customer:</strong> <span id="orderCustomer">-</span></div>
                                <div><strong>Order Date:</strong> <input class="editable-field" id="orderDate" type="date" onchange="markAsChanged()" disabled></div>
                                <div><strong>Delivery Date:</strong> <input class="editable-field" id="deliveryDate" type="date" onchange="markAsChanged()" disabled></div>
                                <div><strong>Total:</strong> <span id="orderTotal">£0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Summary Section -->
            <div class="results-section" id="resultsSection">
                <!-- Export Section -->
                <div class="export-section">
                    <!-- Approve Current Order Button -->
                    <div style="margin-bottom: 20px;">
                        <button class="approve-order-btn" id="approveOrderBtn" onclick="approveCurrentOrder()" style="display: none;">
                            ✅ Approve Current Order
                        </button>
                    </div>
                    
                    <h3>📊 Ready to Export</h3>
                    <p id="exportSummary">No orders approved for export yet - approve orders one by one to include them in export</p>
                    <button class="btn btn-success" id="exportBtn" onclick="exportToExcel()" style="display: none;">
                        Download Excel File
                    </button>
                    
                    <!-- Approved Orders List -->
                    <div class="approved-orders-list" id="approvedOrdersList" style="display: none;">
                        <h3>✅ Approved Orders - Ready for Export</h3>
                        <div id="approvedOrdersContainer">
                            <!-- Approved orders will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDeNUflDD7eEiZS9ZE5Z1WwiAMP8Nx4krY",
            authDomain: "email-order-system.firebaseapp.com",
            projectId: "email-order-system",
            storageBucket: "email-order-system.firebasestorage.app",
            messagingSenderId: "148310260005",
            appId: "1:148310260005:web:65014f7b35ebd7e46ec2cc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let processedOrders = [];
        let approvedOrders = []; // NEW: Track individually approved orders
        let customerMappings = new Map();
        let productMappings = new Map();
        let emailMappingsCache = new Map();
        let productConversionsCache = new Map(); // NEW: Store product conversions
        let lastCacheUpdate = 0;
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        let processedPONumbers = new Set(); // Track processed PO numbers to prevent duplicates
        let fileQueue = []; // Queue for files waiting to be processed

        // PDF Viewer variables
        let currentPDF = null;
        let currentPage = 1;
        let totalPages = 1;
        let currentScale = 1.0;
        let pdfFiles = [];
        let currentFileIndex = 0;
        let originalViewport = null;
        let containerWidth = 0;

        // Edit mode variables
        let isEditMode = false;
        let hasUnsavedChanges = false;

        // Conversion tracking
        let conversionStats = {
            converted: 0,
            warnings: 0,
            whole: 0
        };

        // Vendor mappings by product type
        let vendorMappings = new Map();
        
        function initializeVendorMappings() {
            // Frozen products = CoolFoodGroupMaster
            vendorMappings.set('YRASB', 'CoolFoodGroupMaster'); // Frozen Raspberries
            vendorMappings.set('YBLUB', 'CoolFoodGroupMaster'); // Frozen Blueberries  
            vendorMappings.set('YSFB', 'CoolFoodGroupMaster');  // Frozen Summer Fruits
            vendorMappings.set('YCHERB', 'CoolFoodGroupMaster'); // Frozen Cherries
            
            // Add more frozen product codes as needed
            // Any product starting with 'Y' might be frozen, but we'll map specific ones
            
            // Fresh products = Osolocal2U (default for everything else)
        }

        function getVendorForProduct(productCode) {
            return vendorMappings.get(productCode) || 'Osolocal2U';
        }

        // Load product conversions from Firebase
        async function loadProductConversionsFromFirestore() {
            try {
                console.log('Loading product conversions from Firestore...');
                
                const snapshot = await db.collection('productConversions').get();
                
                productConversionsCache.clear();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    productConversionsCache.set(data.productCode, {
                        name: data.productName || '',
                        eachWeight: data.eachWeight
                    });
                });
                
                console.log(`Loaded ${productConversionsCache.size} product conversions`);
                return productConversionsCache;
            } catch (error) {
                console.error('Error loading product conversions:', error);
                return productConversionsCache;
            }
        }

        // Check if quantity is decimal
        function isDecimalQuantity(quantity) {
            return quantity % 1 !== 0;
        }

        // Convert decimal quantities to whole numbers using product conversions
        function convertDecimalQuantity(product) {
            const originalQty = product.originalQuantity || product.quantity;
            const productCode = product.productCode;
            
            // Debug logging
            console.log(`Converting product: ${productCode}, qty: ${originalQty}kg`);
            console.log(`Available conversions:`, Array.from(productConversionsCache.keys()));
            
            // Reset conversion data
            product.conversionApplied = false;
            product.conversionNote = '';
            product.hasWarning = false;
            
            // If quantity is whole number, no conversion needed
            if (!isDecimalQuantity(originalQty)) {
                product.quantity = originalQty;
                product.conversionNote = '';
                console.log(`${productCode}: Whole number, no conversion needed`);
                return product;
            }
            
            // Check if product has conversion settings
            const conversion = productConversionsCache.get(productCode);
            console.log(`${productCode} conversion found:`, conversion);
            
            if (!conversion) {
                // No conversion available - flag as warning
                product.quantity = originalQty;
                product.hasWarning = true;
                product.conversionNote = `⚠️ ${originalQty}kg may round incorrectly in Freshware`;
                console.log(`${productCode}: No conversion available`);
                return product;
            }
            
            // Calculate conversion: kg to "each" units
            const kgToGrams = originalQty * 1000;
            const eachUnits = kgToGrams / conversion.eachWeight;
            
            // Round to avoid floating point precision issues
            const roundedEachUnits = Math.round(eachUnits * 100) / 100;
            
            console.log(`${productCode}: ${originalQty}kg = ${kgToGrams}g ÷ ${conversion.eachWeight}g = ${eachUnits} units (rounded: ${roundedEachUnits})`);
            
            // Check if conversion results in whole number (or very close to it)
            if (Math.abs(roundedEachUnits - Math.round(roundedEachUnits)) > 0.001) {
                // Still decimal after conversion - flag as warning
                product.quantity = originalQty;
                product.hasWarning = true;
                product.conversionNote = `⚠️ ${originalQty}kg → ${roundedEachUnits.toFixed(1)} ${productCode}E (still decimal)`;
                console.log(`${productCode}: Still decimal after conversion`);
                return product;
            }
            
            // Successful conversion to whole number
            const wholeEachUnits = Math.round(roundedEachUnits);
            
            // Calculate the correct net price FIRST (based on original quantity and original unit price)
            const correctNetPrice = originalQty * product.unitPrice;
            
            // Now calculate the new unit price per "each"
            const newUnitPrice = correctNetPrice / wholeEachUnits;
            
            // Update product with converted values
            product.quantity = wholeEachUnits;
            product.unitPrice = newUnitPrice;
            product.netPrice = correctNetPrice; // This stays the same as original calculation
            product.conversionApplied = true;
            product.conversionNote = `✅ ${originalQty}kg → ${wholeEachUnits} ${productCode}E (${conversion.eachWeight}g each)`;
            
            console.log(`${productCode}: Successfully converted to ${wholeEachUnits} units at £${newUnitPrice.toFixed(2)} each`);
            return product;
        }

        // Helper function to determine case size type from existing values
        function getCaseSizeType(caseSize) {
            if (!caseSize) return 'Each';
            
            const caseLower = caseSize.toLowerCase();
            
            if (caseLower.includes('kg') || caseLower.includes('kilo')) {
                return 'Kilo';
            } else if (caseLower.includes('box') || caseLower.includes('bx')) {
                return 'Box';
            } else {
                return 'Each';
            }
        }

        // Get SKU suffix with conversion logic
        function getSKUSuffix(product) {
            const caseSize = product.caseSize;
            const productCode = product.productCode;
            
            // If conversion was applied, always use E suffix
            if (product.conversionApplied) {
                return 'E';
            }
            
            if (!caseSize) return 'E'; // Default to EACH if no case size
            
            // Handle the simplified dropdown values
            if (caseSize === 'Kilo') {
                // Check if this product should avoid K suffix due to decimals
                const hasConversion = productConversionsCache.has(productCode);
                const isDecimal = isDecimalQuantity(product.originalQuantity || product.quantity);
                
                if (hasConversion && isDecimal) {
                    // This should have been converted, but if we're here something went wrong
                    return 'E';
                }
                return 'K';
            } else if (caseSize === 'Box') {
                return 'B';
            } else {
                return 'E'; // Default to EACH for "Each" and everything else
            }
        }

        // Update conversion statistics
        function updateConversionStats() {
            conversionStats = { converted: 0, warnings: 0, whole: 0 };
            
            if (currentFileIndex >= 0 && currentFileIndex < pdfFiles.length) {
                const order = pdfFiles[currentFileIndex].order;
                
                order.products.forEach(product => {
                    const originalQty = product.originalQuantity || product.quantity;
                    
                    if (!isDecimalQuantity(originalQty)) {
                        conversionStats.whole++;
                    } else if (product.conversionApplied) {
                        conversionStats.converted++;
                    } else {
                        conversionStats.warnings++;
                    }
                });
            }
            
            // Update display
            document.getElementById('convertedCount').textContent = conversionStats.converted;
            document.getElementById('warningCount').textContent = conversionStats.warnings;
            document.getElementById('wholeCount').textContent = conversionStats.whole;
            
            // Show/hide conversion status section
            const hasDecimals = conversionStats.converted > 0 || conversionStats.warnings > 0;
            document.getElementById('conversionStatus').style.display = hasDecimals ? 'block' : 'none';
        }

        // Firebase Functions
        async function loadCustomerEmailsFromFirestore() {
            try {
                console.log('Loading customer emails from Firestore...');
                
                const snapshot = await db.collection('customerEmails').get();
                
                emailMappingsCache.clear();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Store both original and uppercase versions for case-insensitive lookup
                    emailMappingsCache.set(data.customerCode, data.email);
                    emailMappingsCache.set(data.customerCode.toUpperCase(), data.email);
                    if (data.customerName) {
                        emailMappingsCache.set(data.customerName, data.email);
                        emailMappingsCache.set(data.customerName.toUpperCase(), data.email);
                    }
                });
                
                lastCacheUpdate = Date.now();
                console.log(`Loaded ${emailMappingsCache.size} customer email mappings`);
                
                return emailMappingsCache;
            } catch (error) {
                console.error('Error loading customer emails:', error);
                return emailMappingsCache;
            }
        }

        async function getCustomerEmail(customerCode, customerName) {
            if (Date.now() - lastCacheUpdate > CACHE_DURATION) {
                await loadCustomerEmailsFromFirestore();
                await loadProductConversionsFromFirestore();
            }
            
            // Try exact match first, then uppercase versions
            return emailMappingsCache.get(customerCode) || 
                   emailMappingsCache.get(customerCode.toUpperCase()) ||
                   emailMappingsCache.get(customerName) || 
                   emailMappingsCache.get(customerName.toUpperCase()) ||
                   '';
        }

        // Save order history to Firebase
        async function saveOrderHistory(orders) {
            try {
                console.log('Saving order history to Firebase...');
                
                const batch = db.batch();
                const now = new Date();
                
                for (const order of orders) {
                    const historyData = {
                        // Order identification
                        customerCode: order.customerCode || '',
                        customerName: order.customerName || '',
                        purchaseOrderNumber: order.poNumber || '',
                        
                        // Dates
                        orderDate: order.orderDate || '',
                        deliveryDate: order.deliveryDate || '',
                        exportedAt: now,
                        
                        // Order summary
                        orderType: order.type || '',
                        totalProducts: order.products.length,
                        totalQuantity: order.products.reduce((sum, product) => sum + product.quantity, 0),
                        totalValue: order.total,
                        
                        // File reference
                        originalFileName: order.filename || '',
                        
                        // Products summary (for reference)
                        productCodes: order.products.map(p => p.productCode).join(', '),
                        
                        // Conversion statistics
                        conversionsApplied: order.products.filter(p => p.conversionApplied).length,
                        warningsGenerated: order.products.filter(p => p.hasWarning).length
                    };
                    
                    // Create document with auto-generated ID
                    const docRef = db.collection('orderHistory').doc();
                    batch.set(docRef, historyData);
                }
                
                await batch.commit();
                console.log(`Successfully saved ${orders.length} orders to history`);
                
            } catch (error) {
                console.error('Error saving order history:', error);
                // Don't block the export if history saving fails
            }
        }

        // Load processed PO numbers from order history
        async function loadProcessedPONumbers() {
            try {
                console.log('Loading processed PO numbers from order history...');
                
                const snapshot = await db.collection('orderHistory')
                    .orderBy('exportedAt', 'desc')
                    .limit(1000) // Load last 1000 orders to check for duplicates
                    .get();
                
                processedPONumbers.clear();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.purchaseOrderNumber) {
                        processedPONumbers.add(data.purchaseOrderNumber);
                    }
                });
                
                console.log(`Loaded ${processedPONumbers.size} processed PO numbers for duplicate detection`);
                
            } catch (error) {
                console.error('Error loading processed PO numbers:', error);
                // Don't throw error - duplicate detection will still work for current session
            }
        }
        
        // Initialize known mappings
        async function initializeMappings() {
            // Customer mappings
            customerMappings.set('07BELLA', 'BELLA_KITCHEN');
            customerMappings.set('13RREST', 'RIVER_KITCHEN');
            customerMappings.set('92TABLE', 'TABLE_KITCHEN');
            customerMappings.set('76RICH', 'RICHMOND_HOUSE');
            
            // Product mappings
            productMappings.set('AVO', 'AVOCADO_PEAR');
            productMappings.set('KI', 'KIWI_FRUIT');
            productMappings.set('PINL', 'PINEAPPLE_LARGE');
            productMappings.set('CAU', 'CAULIFLOWER');
            productMappings.set('PLUR', 'PLUMS');
            productMappings.set('SAT', 'SATSUMAS');
            productMappings.set('STR', 'STRAWBERRIES');
            productMappings.set('CEL', 'CELERY');
            productMappings.set('GRBS', 'GRAPES_BLACK'); 
            productMappings.set('GRWS', 'GRAPES_WHITE');
            productMappings.set('POSW', 'POTATO_SWEET');

            // Initialize vendor mappings
            initializeVendorMappings();

            // Load email mappings and product conversions from Firestore
            await loadCustomerEmailsFromFirestore();
            await loadProductConversionsFromFirestore();
        }
        
        // Initialize the application
        async function init() {
            await initializeMappings();
            setupEventListeners();
            setupPDFControls();
            
            // Load processed PO numbers on page load
            await loadProcessedPONumbers();
            
            console.log('App initialized successfully');
        }
        
        // Setup event listeners
        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // File input change
            fileInput.addEventListener('change', handleFiles);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadArea.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                addFilesToQueue(files);
            });
            
            uploadArea.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    fileInput.click();
                }
            });

            // Window resize handler for PDF container
            window.addEventListener('resize', () => {
                if (currentPDF) {
                    setTimeout(() => {
                        renderPage(currentPage);
                    }, 100);
                }
            });
        }
        
        // Setup PDF Controls
        function setupPDFControls() {
            document.getElementById('prevPageBtn').addEventListener('click', prevPage);
            document.getElementById('nextPageBtn').addEventListener('click', nextPage);
            document.getElementById('fitWidthBtn').addEventListener('click', fitToWidth);
        }
        
        // Handle file selection - add to queue instead of processing immediately
        function handleFiles(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                addFilesToQueue(files);
            }
        }
        
        // Add files to processing queue
        function addFilesToQueue(files) {
            const pdfFiles = files.filter(f => 
                f.type === 'application/pdf' || 
                f.name.toLowerCase().endsWith('.pdf')
            );
            
            if (pdfFiles.length === 0) {
                alert('Please select PDF files only.');
                return;
            }
            
            // Add files to queue with unique IDs
            pdfFiles.forEach(file => {
                const queueItem = {
                    id: Date.now() + Math.random(), // Unique ID
                    file: file,
                    addedAt: new Date()
                };
                fileQueue.push(queueItem);
            });
            
            updateQueueDisplay();
            
            // Clear the file input
            document.getElementById('fileInput').value = '';
        }
        
        // Update queue display
        function updateQueueDisplay() {
            const queueSection = document.getElementById('queueSection');
            const queueList = document.getElementById('queueList');
            const queueCount = document.getElementById('queueCount');
            const processAllBtn = document.getElementById('processAllBtn');
            
            if (fileQueue.length === 0) {
                queueSection.style.display = 'none';
                return;
            }
            
            queueSection.style.display = 'block';
            queueCount.textContent = `${fileQueue.length} file${fileQueue.length !== 1 ? 's' : ''}`;
            
            // Update queue list
            queueList.innerHTML = '';
            fileQueue.forEach(queueItem => {
                const queueItemDiv = document.createElement('div');
                queueItemDiv.className = 'queue-item';
                queueItemDiv.innerHTML = `
                    <div class="queue-item-info">
                        <div class="queue-item-name">📄 ${queueItem.file.name}</div>
                        <div class="queue-item-details">
                            ${formatFileSize(queueItem.file.size)} • Added ${formatTimeAgo(queueItem.addedAt)}
                        </div>
                    </div>
                    <div class="queue-item-actions">
                        <button class="btn-remove" onclick="removeFromQueue('${queueItem.id}')">
                            Remove
                        </button>
                    </div>
                `;
                queueList.appendChild(queueItemDiv);
            });
            
            // Enable/disable process button
            processAllBtn.disabled = fileQueue.length === 0;
        }
        
        // Remove item from queue (global function)
        window.removeFromQueue = function(id) {
            fileQueue = fileQueue.filter(item => item.id !== id);
            updateQueueDisplay();
        };
        
        // Clear entire queue (global function)  
        window.clearQueue = function() {
            if (fileQueue.length === 0) return;
            
            const confirmClear = confirm(`Are you sure you want to remove all ${fileQueue.length} file(s) from the queue?`);
            if (confirmClear) {
                fileQueue = [];
                updateQueueDisplay();
            }
        };
        
        // Process all queued files (global function)
        window.processAllQueuedFiles = async function() {
            if (fileQueue.length === 0) {
                alert('No files in queue to process.');
                return;
            }
            
            const files = fileQueue.map(item => item.file);
            
            // Clear the queue as we're processing them
            fileQueue = [];
            updateQueueDisplay();
            
            // Process all files
            await processFiles(files);
        };
        
        // Helper functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffMins < 1) return 'just now';
            if (diffMins === 1) return '1 minute ago';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours === 1) return '1 hour ago';
            if (diffHours < 24) return `${diffHours} hours ago`;
            
            return date.toLocaleDateString();
        }
        
        // Process PDF files with duplicate detection
        async function processFiles(files) {
            document.getElementById('processingSection').style.display = 'block';
            document.getElementById('pdfViewerSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Clear current session but keep historical PO numbers for duplicate detection
            processedOrders = [];
            approvedOrders = []; // Reset approved orders for new batch
            pdfFiles = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateProgress((i / files.length) * 100, `Processing ${file.name}...`);
                
                try {
                    const order = await processPDF(file);
                    if (order) {
                        // Check for duplicate PO number (both historical and current session)
                        const poNumber = order.poNumber || '';
                        if (poNumber && processedPONumbers.has(poNumber)) {
                            // Show duplicate warning and wait for user decision
                            const shouldProcess = await showDuplicateWarning(order, file.name);
                            if (!shouldProcess) {
                                // User chose to skip this order
                                continue;
                            }
                        }
                        
                        // Apply decimal conversions to all products
                        order.products = order.products.map(product => {
                            // Store original quantity before conversion
                            product.originalQuantity = product.quantity;
                            return convertDecimalQuantity(product);
                        });
                        
                        // Recalculate order total after conversions
                        order.total = order.products.reduce((sum, product) => sum + product.netPrice, 0);
                        
                        processedOrders.push(order);
                        pdfFiles.push({
                            file: file,
                            order: order,
                            pdf: null // Will be loaded when viewed
                        });
                        
                        // Add PO number to processed set for this session
                        if (poNumber) {
                            processedPONumbers.add(poNumber);
                        }
                    }
                } catch (error) {
                    console.error(`Error processing ${file.name}:`, error);
                    alert(`Error processing ${file.name}: ${error.message}`);
                }
            }
            
            updateProgress(100, 'Processing complete!');
            setTimeout(() => {
                document.getElementById('processingSection').style.display = 'none';
                displayPDFViewer();
                displayResults();
            }, 1000);
        }
        
        // Show duplicate PO warning and get user decision
        function showDuplicateWarning(order, filename) {
            return new Promise((resolve) => {
                // Hide processing section temporarily
                document.getElementById('processingSection').style.display = 'none';
                
                // Create duplicate warning section
                const duplicateSection = document.createElement('div');
                duplicateSection.id = 'duplicateWarningSection';
                duplicateSection.innerHTML = `
                    <div class="duplicate-warning">
                        <h3>⚠️ Duplicate Purchase Order Detected</h3>
                        <p>The purchase order number <span class="po-highlight">${order.poNumber || 'Unknown'}</span> has already been processed.</p>
                        <p><strong>File:</strong> ${filename}</p>
                        <p><strong>Customer:</strong> ${order.customerName} (${order.customerCode})</p>
                        <p><strong>Order Date:</strong> ${order.orderDate}</p>
                        <p>Processing this order again may create duplicate entries in your system.</p>
                        
                        <div class="duplicate-actions">
                            <button class="btn-skip" onclick="handleDuplicateChoice(false)">
                                🚫 Skip This Order
                            </button>
                            <button class="btn-process-anyway" onclick="handleDuplicateChoice(true)">
                                ⚠️ Process Anyway
                            </button>
                        </div>
                    </div>
                `;
                
                // Insert after processing section
                const processingSection = document.getElementById('processingSection');
                processingSection.parentNode.insertBefore(duplicateSection, processingSection.nextSibling);
                
                // Store the resolve function globally so the buttons can access it
                window.currentDuplicateResolve = resolve;
            });
        }
        
        // Handle user choice for duplicate order (global function)
        window.handleDuplicateChoice = function(shouldProcess) {
            // Remove the duplicate warning section
            const duplicateSection = document.getElementById('duplicateWarningSection');
            if (duplicateSection) {
                duplicateSection.remove();
            }
            
            // Show processing section again
            document.getElementById('processingSection').style.display = 'block';
            
            // Resolve the promise with user's choice
            if (window.currentDuplicateResolve) {
                window.currentDuplicateResolve(shouldProcess);
                window.currentDuplicateResolve = null;
            }
        };
        
        async function displayPDFViewer() {
            if (pdfFiles.length === 0) return;
            
            document.getElementById('pdfViewerSection').style.display = 'block';
            
            // Create file tabs using the same logic as refresh
            refreshFileTabsAfterApproval();
            
            // Load first PDF
            currentFileIndex = 0;
            await loadPDFForViewing(0);
            
            // Update approval UI
            updateApprovalUI();
        }
        
        // Switch to different file
        async function switchToFile(index) {
            // Check for unsaved changes
            if (hasUnsavedChanges) {
                const confirmSwitch = confirm('You have unsaved changes. Do you want to save them before switching files?\n\nClick OK to save, or Cancel to discard changes.');
                if (confirmSwitch) {
                    saveChanges();
                } else {
                    // Discard changes by reloading the current file
                    hasUnsavedChanges = false;
                    updateEditModeUI();
                }
            }
            
            // Update active tab
            document.querySelectorAll('.file-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
                
                // Maintain approval status when switching
                const order = pdfFiles[i].order;
                const isApproved = approvedOrders.find(o => o.filename === order.filename);
                if (isApproved) {
                    tab.classList.add('approved');
                } else {
                    tab.classList.remove('approved');
                }
            });
            
            currentFileIndex = index;
            await loadPDFForViewing(index);
        }
        
        // Load PDF for viewing
        async function loadPDFForViewing(index) {
            const pdfFile = pdfFiles[index];
            
            try {
                if (!pdfFile.pdf) {
                    const arrayBuffer = await pdfFile.file.arrayBuffer();
                    pdfFile.pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                }
                
                currentPDF = pdfFile.pdf;
                totalPages = currentPDF.numPages;
                currentPage = 1;
                
                // Update filename display
                document.getElementById('currentFileName').textContent = pdfFile.file.name;
                
                // Get container dimensions for smart scaling
                const container = document.querySelector('.pdf-canvas-container');
                containerWidth = container.clientWidth - 40; // Account for padding
                
                // Calculate smart initial scale
                await calculateSmartScale();
                
                // Render first page
                await renderPage(1);
                
                // Update extracted data display
                updateExtractedDataDisplay(pdfFile.order);
                
                // Reset edit mode for new file
                isEditMode = false;
                hasUnsavedChanges = false;
                updateEditModeUI();
                
                // Update approval UI for this file
                updateApprovalUI();
                
            } catch (error) {
                console.error('Error loading PDF for viewing:', error);
            }
        }
        
        // Calculate smart initial scale
        async function calculateSmartScale() {
            if (!currentPDF) return;
            
            try {
                const page = await currentPDF.getPage(1);
                originalViewport = page.getViewport({ scale: 1.0 });
                
                // Calculate scale to fit width of container
                const widthScale = containerWidth / originalViewport.width;
                
                // Don't make it too small or too large
                const minScale = 0.5;
                const maxScale = 2.0;
                const smartScale = Math.max(minScale, Math.min(maxScale, widthScale * 0.9)); // 90% of container width
                
                currentScale = smartScale;
                console.log(`Smart scale calculated: ${currentScale.toFixed(2)} (container: ${containerWidth}px, PDF: ${originalViewport.width}px)`);
                
            } catch (error) {
                console.error('Error calculating smart scale:', error);
                currentScale = 1.2; // Fallback scale
            }
        }
        
        // Render PDF page with improved scaling
        async function renderPage(pageNum) {
            if (!currentPDF) return;
            
            try {
                const page = await currentPDF.getPage(pageNum);
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                
                const viewport = page.getViewport({ scale: currentScale });
                
                // Set canvas dimensions
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                // Update page info
                document.getElementById('pageInfo').textContent = `Page ${pageNum} of ${totalPages}`;
                
                // Update zoom info
                const zoomPercent = Math.round(currentScale * 100);
                document.getElementById('zoomInfo').textContent = `${zoomPercent}%`;
                
                // Update button states
                document.getElementById('prevPageBtn').disabled = pageNum <= 1;
                document.getElementById('nextPageBtn').disabled = pageNum >= totalPages;
                
                // Update fit width button state
                const fitWidthBtn = document.getElementById('fitWidthBtn');
                const isAtFitWidth = Math.abs(currentScale - calculateFitWidthScale()) < 0.01;
                fitWidthBtn.classList.toggle('active', isAtFitWidth);
                
            } catch (error) {
                console.error('Error rendering page:', error);
            }
        }
        
        // Calculate fit-to-width scale
        function calculateFitWidthScale() {
            if (!originalViewport || !containerWidth) return 1.0;
            return (containerWidth * 0.9) / originalViewport.width;
        }
        
        // Fit to width function
        async function fitToWidth() {
            if (!originalViewport) return;
            
            const newScale = calculateFitWidthScale();
            currentScale = newScale;
            await renderPage(currentPage);
        }
        
        // PDF Navigation
        function prevPage() {
            if (currentPage <= 1) return;
            currentPage--;
            renderPage(currentPage);
        }
        
        function nextPage() {
            if (currentPage >= totalPages) return;
            currentPage++;
            renderPage(currentPage);
        }
        
        function zoomIn() {
            currentScale = Math.min(currentScale * 1.25, 3.0);
            renderPage(currentPage);
        }
        
        function zoomOut() {
            currentScale = Math.max(currentScale / 1.25, 0.3);
            renderPage(currentPage);
        }
        
        // NEW: Approval Functions
        function approveCurrentOrder() {
            if (currentFileIndex >= 0 && currentFileIndex < pdfFiles.length) {
                const order = pdfFiles[currentFileIndex].order;
                const filename = order.filename;
                
                // Check if already approved
                if (approvedOrders.find(o => o.filename === filename)) {
                    alert('This order is already approved!');
                    return;
                }
                
                // Add to approved orders
                approvedOrders.push(order);
                
                // Remove from pdfFiles array
                pdfFiles.splice(currentFileIndex, 1);
                
                // Update UI
                updateApprovedOrdersList();
                updateExportSection();
                
                // Handle file switching after removal
                if (pdfFiles.length === 0) {
                    // No more files to review
                    document.getElementById('pdfViewerSection').style.display = 'none';
                    updateApprovalUI();
                    alert(`✅ Order ${order.poNumber || order.filename} approved!\n\nAll orders have been processed and are ready for export.`);
                } else {
                    // Switch to next available file
                    if (currentFileIndex >= pdfFiles.length) {
                        currentFileIndex = pdfFiles.length - 1;
                    }
                    
                    // Refresh file tabs and load new current file
                    refreshFileTabsAfterApproval();
                    loadPDFForViewing(currentFileIndex);
                    
                    alert(`✅ Order ${order.poNumber || order.filename} approved and moved to export list!\n\n${pdfFiles.length} order${pdfFiles.length !== 1 ? 's' : ''} remaining to review.`);
                }
            }
        }
        
        // Refresh file tabs after approval (removes approved file tab)
        function refreshFileTabsAfterApproval() {
            const tabsContainer = document.getElementById('fileTabsContainer');
            tabsContainer.innerHTML = '';
            
            if (pdfFiles.length === 0) {
                tabsContainer.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">All orders approved! ✅</p>';
                return;
            }
            
            pdfFiles.forEach((pdfFile, index) => {
                const tab = document.createElement('button');
                tab.className = `file-tab ${index === currentFileIndex ? 'active' : ''}`;
                tab.textContent = pdfFile.file.name;
                tab.onclick = () => switchToFile(index);
                tabsContainer.appendChild(tab);
            });
        }
        
        function updateApprovalUI() {
            const approveBtn = document.getElementById('approveOrderBtn');
            
            // Show button if we have files to review
            if (pdfFiles.length > 0) {
                approveBtn.style.display = 'inline-block';
                approveBtn.textContent = '✅ Approve Current Order';
                approveBtn.classList.remove('approved');
                approveBtn.disabled = false;
            } else {
                approveBtn.style.display = 'none';
            }
        }
        
        function updateExportSection() {
            const exportSummary = document.getElementById('exportSummary');
            const exportBtn = document.getElementById('exportBtn');
            
            const approvedCount = approvedOrders.length;
            const totalValue = approvedOrders.reduce((sum, order) => sum + order.total, 0);
            const totalProducts = approvedOrders.reduce((sum, order) => sum + order.products.length, 0);
            const remainingCount = pdfFiles.length;
            
            if (approvedCount === 0) {
                exportSummary.textContent = 'No orders approved for export yet - approve orders one by one to include them in export';
                exportBtn.style.display = 'none';
            } else {
                let summaryText = `<strong>${approvedCount}</strong> order${approvedCount !== 1 ? 's' : ''} approved<br>`;
                summaryText += `<strong>${totalProducts}</strong> products • <strong>£${totalValue.toFixed(2)}</strong> total value<br>`;
                
                if (remainingCount > 0) {
                    summaryText += `<em>${remainingCount} order${remainingCount !== 1 ? 's' : ''} still pending approval</em><br>`;
                }
                
                summaryText += 'Ready for Freshware import';
                exportSummary.innerHTML = summaryText;
                exportBtn.style.display = 'inline-block';
            }
        }
        
        // Update extracted data display
        function updateExtractedDataDisplay(order) {
            // Update order summary (now at bottom)
            document.getElementById('orderType').textContent = order.type;
            document.getElementById('orderPO').value = order.poNumber || '';
            
            // Show approval status in customer display
            const isApproved = approvedOrders.find(o => o.filename === order.filename);
            const approvalStatus = isApproved ? ' ✅ APPROVED' : '';
            document.getElementById('orderCustomer').textContent = `${order.customerName} (${order.customerCode})${approvalStatus}`;
            
            // Convert dates from DD/MM/YYYY to YYYY-MM-DD for date inputs
            document.getElementById('orderDate').value = convertDateForInput(order.orderDate);
            document.getElementById('deliveryDate').value = convertDateForInput(order.deliveryDate);
            document.getElementById('orderTotal').textContent = `£${order.total.toFixed(2)}`;
            
            // Update products table
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            if (order.products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #7f8c8d; padding: 40px;">
                            No products found in this order
                        </td>
                    </tr>
                `;
            } else {
                order.products.forEach((product, index) => {
                    const skuWithSuffix = product.productCode + getSKUSuffix(product);
                    const row = document.createElement('tr');
                    
                    // Add styling based on conversion status
                    if (product.hasWarning) {
                        row.classList.add('decimal-warning');
                    } else if (product.conversionApplied) {
                        // Add green highlighting for successful conversions
                        row.classList.add('conversion-success');
                    }
                    
                    row.innerHTML = `
                        <td class="editable-cell">
                            <input type="number" step="0.1" value="${product.quantity}" 
                                   onchange="updateProductField(${index}, 'quantity', this.value)" />
                            ${product.conversionNote ? `<div class="conversion-note ${product.conversionApplied ? 'converted' : 'warning'}">${product.conversionNote}</div>` : ''}
                        </td>
                        <td>${product.description}</td>
                        <td class="editable-cell">
                            <input type="text" value="${product.productCode}" 
                                   onchange="updateProductField(${index}, 'productCode', this.value)" 
                                   style="text-transform: uppercase;" />
                        </td>
                        <td class="editable-cell">
                            <select onchange="updateProductField(${index}, 'caseSize', this.value)">
                                <option value="Each" ${getCaseSizeType(product.caseSize) === 'Each' ? 'selected' : ''}>Each</option>
                                <option value="Kilo" ${getCaseSizeType(product.caseSize) === 'Kilo' ? 'selected' : ''}>Kilo</option>
                                <option value="Box" ${getCaseSizeType(product.caseSize) === 'Box' ? 'selected' : ''}>Box</option>
                            </select>
                        </td>
                        <td>£${product.unitPrice.toFixed(2)}</td>
                        <td>£${product.netPrice.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Update conversion statistics
            updateConversionStats();
            
            // Reset edit mode
            isEditMode = false;
            hasUnsavedChanges = false;
            updateEditModeUI();
        }
        
        // Convert date from DD/MM/YYYY to YYYY-MM-DD
        function convertDateForInput(dateStr) {
            if (!dateStr || dateStr === '') return '';
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return dateStr;
        }
        
        // Convert date from YYYY-MM-DD to DD/MM/YYYY
        function convertDateFromInput(dateStr) {
            if (!dateStr || dateStr === '') return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return dateStr;
        }
        
        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            updateEditModeUI();
        }
        
        // Update UI based on edit mode
        function updateEditModeUI() {
            const editBtn = document.getElementById('editToggleBtn');
            const saveBtn = document.getElementById('saveChangesBtn');
            const changesIndicator = document.getElementById('changesIndicator');
            const editableFields = document.querySelectorAll('.editable-field');
            const editableCells = document.querySelectorAll('.editable-cell');
            
            if (isEditMode) {
                editBtn.textContent = '👁️ View Mode';
                editBtn.classList.add('editing');
                saveBtn.style.display = hasUnsavedChanges ? 'inline-block' : 'none';
                
                // Enable editing
                editableFields.forEach(field => {
                    field.classList.add('editing');
                    field.disabled = false;
                });
                
                editableCells.forEach(cell => {
                    cell.classList.add('editing');
                    const input = cell.querySelector('input');
                    const select = cell.querySelector('select');
                    if (input) input.disabled = false;
                    if (select) select.disabled = false;
                });
            } else {
                editBtn.textContent = '✏️ Edit Data';
                editBtn.classList.remove('editing');
                saveBtn.style.display = 'none';
                
                // Disable editing
                editableFields.forEach(field => {
                    field.classList.remove('editing');
                    field.disabled = true;
                });
                
                editableCells.forEach(cell => {
                    cell.classList.remove('editing');
                    const input = cell.querySelector('input');
                    const select = cell.querySelector('select');
                    if (input) input.disabled = true;
                    if (select) select.disabled = true;
                });
            }
            
            // Show/hide changes indicator
            changesIndicator.style.display = hasUnsavedChanges ? 'inline' : 'none';
        }
        
        // Mark as changed
        function markAsChanged() {
            hasUnsavedChanges = true;
            updateEditModeUI();
        }
        
        // Update product field
        function updateProductField(productIndex, field, value) {
            if (currentFileIndex >= 0 && currentFileIndex < pdfFiles.length) {
                const order = pdfFiles[currentFileIndex].order;
                if (productIndex >= 0 && productIndex < order.products.length) {
                    const product = order.products[productIndex];
                    
                    if (field === 'quantity') {
                        const newQuantity = parseFloat(value) || 0;
                        
                        // Store the original unit price before conversion
                        const originalUnitPrice = product.originalUnitPrice || product.unitPrice;
                        
                        // Update the quantity and reapply conversion logic
                        product.originalQuantity = newQuantity;
                        product.originalUnitPrice = originalUnitPrice;
                        
                        const convertedProduct = convertDecimalQuantity(product);
                        
                        // Update the product in the order
                        order.products[productIndex] = convertedProduct;
                        
                        // Recalculate order total
                        order.total = order.products.reduce((sum, product) => sum + product.netPrice, 0);
                        document.getElementById('orderTotal').textContent = `£${order.total.toFixed(2)}`;
                        
                        // Refresh the display to show new conversion status
                        updateExtractedDataDisplay(order);
                        
                    } else if (field === 'productCode') {
                        product.productCode = value.toUpperCase();
                        
                        // Reapply conversion logic with new product code
                        const convertedProduct = convertDecimalQuantity(product);
                        order.products[productIndex] = convertedProduct;
                        
                        // Update conversion statistics
                        updateConversionStats();
                    } else if (field === 'caseSize') {
                        product.caseSize = value;
                    }
                    
                    // Update processed orders array
                    const processedOrderIndex = processedOrders.findIndex(o => o.filename === order.filename);
                    if (processedOrderIndex >= 0) {
                        processedOrders[processedOrderIndex] = order;
                    }
                    
                    markAsChanged();
                }
            }
        }
        
        // Save changes
        function saveChanges() {
            if (currentFileIndex >= 0 && currentFileIndex < pdfFiles.length) {
                const order = pdfFiles[currentFileIndex].order;
                
                // Update order data from form fields
                order.poNumber = document.getElementById('orderPO').value;
                order.orderDate = convertDateFromInput(document.getElementById('orderDate').value);
                order.deliveryDate = convertDateFromInput(document.getElementById('deliveryDate').value);
                
                // Update processed orders array
                const processedOrderIndex = processedOrders.findIndex(o => o.filename === order.filename);
                if (processedOrderIndex >= 0) {
                    processedOrders[processedOrderIndex] = order;
                }
                
                // Update display with new data
                updateExtractedDataDisplay(order);
                
                hasUnsavedChanges = false;
                updateEditModeUI();
                
                alert('✅ Changes saved successfully!');
                
                // Update export section
                updateExportSection();
            }
        }
        
        // Real PDF processing with PDF.js
        async function processPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const page = await pdf.getPage(1);
                const textContent = await page.getTextContent();
                
                // Extract text from PDF
                const text = textContent.items.map(item => item.str).join(' ');
                
                // Determine template type and parse
                const isConsolidated = text.includes('Consolidated Purchase Order');
                const isPickingNote = text.includes('Picking Note');
                
                if (isPickingNote) {
                    return parsePickingNote(text, file.name);
                } else if (isConsolidated) {
                    return parseConsolidatedOrder(text, file.name);
                } else {
                    return parseStandardOrder(text, file.name);
                }
            } catch (error) {
                console.error('Error processing PDF:', error);
                throw error;
            }
        }
        
        // Parse consolidated order template
        function parseConsolidatedOrder(text, filename) {
            const order = {
                filename: filename,
                type: 'Consolidated',
                customerCode: '',
                customerName: '',
                poNumber: '',
                orderDate: '',
                deliveryDate: '',
                products: [],
                total: 0
            };
            
            // Extract PO Number
            const poPatterns = [
                /PO Number:\s*([A-Z0-9]+)/i,
                /Purchase Order[^:]*:\s*([A-Z0-9]+)/i,
                /PO[:\s]+([A-Z0-9]+)/i
            ];
            
            for (const pattern of poPatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.poNumber = match[1];
                    break;
                }
            }
            
            // Extract dates
            const orderDatePatterns = [
                /Order Date:\s*(\d{2}\/\d{2}\/\d{4})/,
                /Date:\s*(\d{2}\/\d{2}\/\d{4})/
            ];
            
            for (const pattern of orderDatePatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.orderDate = match[1];
                    break;
                }
            }
            
            const deliveryDatePatterns = [
                /Delivery Date:\s*(\d{2}\/\d{2}\/\d{4})/,
                /Deliver[^:]*:\s*(\d{2}\/\d{2}\/\d{4})/
            ];
            
            for (const pattern of deliveryDatePatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.deliveryDate = match[1];
                    break;
                }
            }
            
            // Extract customer info
            const customerPatterns = [
                /following outlets[^:]*:\s*([^(]+)\s*\(([^)]+)\)/i,
                /outlets[^:]*:\s*([^(]+)\s*\(([^)]+)\)/i,
                /The\s+([^(]+)\s*\(([^)]+)\)/i
            ];
            
            for (const pattern of customerPatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.customerName = match[1].trim();
                    order.customerCode = match[2].trim();
                    break;
                }
            }
            
            // Extract products
            const productPatterns = [
                /(\d+\.?\d*)\s+([A-Z\s]+?)\s+([A-Z]+)\s+(1x[A-Za-z]+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g,
                /(\d+\.?\d*)\s+([A-Z][A-Z\s]+?)\s+([A-Z]{2,5})\s+([^\d]+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g
            ];
            
            for (const pattern of productPatterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const product = {
                        quantity: parseFloat(match[1]),
                        description: match[2].trim(),
                        productCode: match[3].trim(),
                        caseSize: match[4].trim(),
                        unitPrice: parseFloat(match[5]),
                        netPrice: parseFloat(match[6])
                    };
                    
                    if (product.quantity > 0 && product.productCode && product.unitPrice > 0) {
                        order.products.push(product);
                        order.total += product.netPrice;
                    }
                }
                
                if (order.products.length > 0) break;
            }
            
            // Extract total if products parsing failed
            if (order.total === 0) {
                const totalPatterns = [
                    /Net Total[:\s]+(\d+\.?\d*)/i,
                    /Total[:\s]+(\d+\.?\d*)/i
                ];
                
                for (const pattern of totalPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        order.total = parseFloat(match[1]);
                        break;
                    }
                }
            }
            
            return order;
        }
        
        // Parse picking note template  
        function parsePickingNote(text, filename) {
            const order = {
                filename: filename,
                type: 'Picking Note',
                customerCode: '',
                customerName: '',
                poNumber: '', // Will use Basket ID
                orderDate: '',
                deliveryDate: '',
                products: [],
                total: 0 // Will be 0 since no pricing
            };
            
            // Extract Basket ID (use as PO Number)
            const basketIdMatch = text.match(/Basket ID\s+(\d+)/);
            if (basketIdMatch) {
                order.poNumber = basketIdMatch[1];
            }
            
            // Extract dates (convert from "30-Jul-2025" to "30/07/2025" format)
            const orderDateMatch = text.match(/Order date\s+(\d{1,2}-[A-Za-z]{3}-\d{4})/);
            if (orderDateMatch) {
                order.orderDate = convertPickingDate(orderDateMatch[1]);
            }
            
            const deliveryDateMatch = text.match(/Delivery date\s+(\d{1,2}-[A-Za-z]{3}-\d{4})/);
            if (deliveryDateMatch) {
                order.deliveryDate = convertPickingDate(deliveryDateMatch[1]);
            }
            
            // Extract Customer Reference (use as customer code)
            const customerRefMatch = text.match(/Customer ref\s+(\S+)/);
            if (customerRefMatch) {
                order.customerCode = customerRefMatch[1];
            }
            
            // Extract Customer Name from Delivery Address section
            const customerNamePatterns = [
                /Delivery Address[^M]*?([A-Za-z][^\\n]*Ltd[^\\n]*)/,
                /Delivery Address[^U]*?(University College Hospital[^\\n]*)/,
                /Delivery Address[^\\n]*\\n[^\\n]*?([A-Za-z][^\\n]*Ltd[^\\n]*)/
            ];
            
            for (const pattern of customerNamePatterns) {
                const match = text.match(pattern);
                if (match) {
                    order.customerName = match[1].trim();
                    break;
                }
            }
            
            // If no customer name found, try alternative approach
            if (!order.customerName) {
                const mitieMatch = text.match(/(Mitie Ltd[^\\n]*)/);
                const hospitalMatch = text.match(/(University College Hospital[^\\n]*)/);
                if (mitieMatch) {
                    order.customerName = mitieMatch[1].trim();
                } else if (hospitalMatch) {
                    order.customerName = hospitalMatch[1].trim();
                }
            }
            
            // Extract products from table
            // Pattern: ProductCode/- Description PackSize Quantity _______
            const productPattern = /(\d+[A-Z]+\/\-)\s+([^\\n]+?)\s+(1x\w+|\d+\.\d+\s+Kg|£\s+per\s+Kg)\s+(\d+(?:\.\d+)?)\s+(?:Kg\s+)?_+/g;
            
            let match;
            while ((match = productPattern.exec(text)) !== null) {
                const productCode = match[1].replace('/-', ''); // Remove /- suffix
                const description = match[2].trim();
                const packSize = match[3].trim();
                const quantity = parseFloat(match[4]);
                
                const product = {
                    quantity: quantity,
                    description: description,
                    productCode: productCode,
                    caseSize: packSize,
                    unitPrice: 0, // No pricing in picking notes
                    netPrice: 0   // No pricing in picking notes
                };
                
                if (product.quantity > 0 && product.productCode) {
                    order.products.push(product);
                }
            }
            
            // Alternative product extraction if main pattern fails
            if (order.products.length === 0) {
                const lines = text.split('\\n');
                let inProductSection = false;
                
                for (const line of lines) {
                    if (line.includes('Product Description Pack size Units ordered')) {
                        inProductSection = true;
                        continue;
                    }
                    
                    if (inProductSection && line.includes('Powered by TCPDF')) {
                        break;
                    }
                    
                    if (inProductSection) {
                        // Match lines like: "119095S/- Kiwi 1x6ea 2 _____________"
                        const productMatch = line.match(/^(\d+[A-Z]+)\/\-\s+(.+?)\s+(1x\w+|\d+\.\d+\s+Kg)\s+(\d+(?:\.\d+)?)/);
                        if (productMatch) {
                            const product = {
                                quantity: parseFloat(productMatch[4]),
                                description: productMatch[2].trim(),
                                productCode: productMatch[1],
                                caseSize: productMatch[3].trim(),
                                unitPrice: 0,
                                netPrice: 0
                            };
                            
                            if (product.quantity > 0 && product.productCode) {
                                order.products.push(product);
                            }
                        }
                    }
                }
            }
            
            // Set total to 0 since no pricing
            order.total = 0;
            
            return order;
        }
        
        // Helper function to convert picking note dates
        function convertPickingDate(dateStr) {
            // Convert "30-Jul-2025" to "30/07/2025"
            const months = {
                'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
            };
            
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const day = parts[0].padStart(2, '0');
                const month = months[parts[1]] || '01';
                const year = parts[2];
                return `${day}/${month}/${year}`;
            }
            
            return dateStr; // Return original if parsing fails
        }
            const order = {
                filename: filename,
                type: 'Standard',
                customerCode: '',
                customerName: '',
                poNumber: '',
                orderDate: '',
                deliveryDate: '',
                products: [],
                total: 0
            };
            
            // Extract PO Number
            const poMatch = text.match(/PO Number:\s*([A-Z0-9]+)/);
            if (poMatch) order.poNumber = poMatch[1];
            
            // Extract dates
            const orderDateMatch = text.match(/Order Date:\s*(\d{2}\/\d{2}\/\d{4})/);
            if (orderDateMatch) order.orderDate = orderDateMatch[1];
            
            const deliveryDateMatch = text.match(/Delivery Date:\s*(\d{2}\/\d{2}\/\d{4})/);
            if (deliveryDateMatch) order.deliveryDate = deliveryDateMatch[1];
            
            // Extract customer code from Account No
            const accountMatch = text.match(/Account No:\s*([A-Z0-9]+)/);
            if (accountMatch) order.customerCode = accountMatch[1];
            
            // Extract customer name from Deliver To section
            const deliverMatch = text.match(/Deliver To\s+([^\n]+)/);
            if (deliverMatch) order.customerName = deliverMatch[1].trim();
            
            // Extract products table
            const tablePattern = /(\d+\.?\d*)\s+([A-Z\s]+?)\s+([A-Z]+)\s+(1x\w+)\s+(\d+\.?\d*)\s+(\d+\.?\d*)/g;
            let match;
            
            while ((match = tablePattern.exec(text)) !== null) {
                const product = {
                    quantity: parseFloat(match[1]),
                    description: match[2].trim(),
                    productCode: match[3].trim(),
                    caseSize: match[4].trim(),
                    unitPrice: parseFloat(match[5]),
                    netPrice: parseFloat(match[6])
                };
                order.products.push(product);
                order.total += product.netPrice;
            }
            
            return order;
        }
        
        // Update progress bar
        function updateProgress(percent, status) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('processingStatus').textContent = status;
        }
        
        // Display processing results
        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            
            // Update export section
            updateExportSection();
            
            resultsSection.style.display = 'block';
        }
        
        // Update approved orders list
        function updateApprovedOrdersList() {
            const approvedOrdersList = document.getElementById('approvedOrdersList');
            const approvedOrdersContainer = document.getElementById('approvedOrdersContainer');
            
            if (approvedOrders.length === 0) {
                approvedOrdersList.style.display = 'none';
                return;
            }
            
            approvedOrdersList.style.display = 'block';
            approvedOrdersContainer.innerHTML = '';
            
            approvedOrders.forEach(order => {
                const orderItem = document.createElement('div');
                orderItem.className = 'approved-order-item';
                orderItem.innerHTML = `
                    <div>
                        <div class="order-item-title">📄 ${order.filename}</div>
                        <div class="order-item-details">
                            <strong>PO:</strong> ${order.poNumber || 'Not specified'} • 
                            <strong>Customer:</strong> ${order.customerName} (${order.customerCode}) • 
                            <strong>Products:</strong> ${order.products.length} • 
                            <strong>Total:</strong> £${order.total.toFixed(2)}
                        </div>
                    </div>
                `;
                approvedOrdersContainer.appendChild(orderItem);
            });
        }
        
        // Export to Excel in Freshware format with email lookup - MODIFIED TO USE APPROVED ORDERS
        async function exportToExcel() {
            // Only export approved orders
            const ordersToExport = approvedOrders;
            
            if (ordersToExport.length === 0) {
                alert('❌ No orders approved for export!\n\nPlease approve at least one order before exporting.');
                return;
            }
            
            // First, validate that all customers have email mappings
            const missingEmails = [];
            
            for (const order of ordersToExport) {
                const customerEmail = await getCustomerEmail(order.customerCode, order.customerName);
                if (!customerEmail || customerEmail.trim() === '') {
                    missingEmails.push({
                        customerCode: order.customerCode,
                        customerName: order.customerName,
                        filename: order.filename
                    });
                }
            }
            
            // Check for decimal warnings across approved orders
            let totalWarnings = 0;
            let warningDetails = [];
            
            ordersToExport.forEach(order => {
                order.products.forEach(product => {
                    if (product.hasWarning) {
                        totalWarnings++;
                        warningDetails.push(`${product.productCode} (${product.originalQuantity}kg) in ${order.filename}`);
                    }
                });
            });
            
            // If any emails are missing, show alert and stop export
            if (missingEmails.length > 0) {
                let alertMessage = '❌ Cannot export! Missing customer email mappings:\n\n';
                
                missingEmails.forEach(missing => {
                    alertMessage += `• ${missing.customerCode} (${missing.customerName}) - from ${missing.filename}\n`;
                });
                
                alertMessage += '\n🔧 Please add these email mappings first:\n';
                alertMessage += '1. Click "Manage Settings" in the top right\n';
                alertMessage += '2. Add the missing customer emails\n';
                alertMessage += '3. Return here and export again\n\n';
                alertMessage += 'Export cancelled - no file was created.';
                
                alert(alertMessage);
                return; // Stop the export process
            }
            
            // Show warning about problematic decimals if any exist
            if (totalWarnings > 0) {
                let warningMessage = `⚠️ Warning: ${totalWarnings} product(s) have decimal quantities that may cause rounding issues in Freshware:\n\n`;
                
                warningDetails.slice(0, 5).forEach(detail => {
                    warningMessage += `• ${detail}\n`;
                });
                
                if (warningDetails.length > 5) {
                    warningMessage += `• ... and ${warningDetails.length - 5} more\n`;
                }
                
                warningMessage += '\n💡 To fix these issues:\n';
                warningMessage += '1. Go to "Manage Settings" → "Product Conversions"\n';
                warningMessage += '2. Add conversion settings for these products\n';
                warningMessage += '3. Re-upload the PDFs to apply conversions\n\n';
                warningMessage += 'Continue with export anyway?';
                
                if (!confirm(warningMessage)) {
                    return; // Stop export if user chooses not to continue
                }
            }
            
            const wb = XLSX.utils.book_new();
            const wsData = [];
            
            // Add header row
            const headers = [
                "Name", "Email", "Financial Status", "Paid at", "Fulfillment Status", "Fulfilled at",
                "Accepts Marketing", "Currency", "Subtotal", "Shipping", "Taxes", "Total", 
                "Discount Code", "Discount Amount", "Shipping Method", "Created at", 
                "Lineitem quantity", "Lineitem name", "Lineitem price", "Lineitem compare at price",
                "Lineitem sku", "Lineitem requires shipping", "Lineitem taxable", "Lineitem fulfillment status",
                "Billing Name", "Billing Street", "Billing Address1", "Billing Address2", "Billing Company",
                "Billing City", "Billing Zip", "Billing Province", "Billing Country", "Billing Phone",
                "Shipping Name", "Shipping Street", "Shipping Address1", "Shipping Address2", "Shipping Company",
                "Shipping City", "Shipping Zip", "Shipping Province", "Shipping Country", "Shipping Phone",
                "Notes", "Note Attributes", "Cancelled at", "Payment Method", "Payment Reference",
                "Refunded Amount", "Vendor", "Outstanding Balance", "Employee", "Location", "Device ID",
                "Id", "Tags", "Risk Level", "Source", "Lineitem discount", "Tax 1 Name", "Tax 1 Value",
                "Tax 2 Name", "Tax 2 Value", "Tax 3 Name", "Tax 3 Value", "Tax 4 Name", "Tax 4 Value",
                "Tax 5 Name", "Tax 5 Value", "Phone", "Receipt Number", "Duties", "Billing Province Name",
                "Shipping Province Name", "Payment ID", "Payment Terms Name", "Next Payment Due At", "Payment References"
            ];
            wsData.push(headers);
            
            // Add data rows with email lookup
            for (const order of ordersToExport) {
                // Get customer email from Firebase
                const customerEmail = await getCustomerEmail(order.customerCode, order.customerName);
                
                for (let productIndex = 0; productIndex < order.products.length; productIndex++) {
                    const product = order.products[productIndex];
                    const row = new Array(79).fill("");
                    
                    // Column A (Name) = Purchase Order Number from PDF (NOT generated ID)
                    row[0] = order.poNumber || `PO-${order.customerCode}-${order.orderDate}`; // Name - PO Number
                    row[1] = customerEmail; // Email - FROM FIREBASE!
                    
                    // Order-level data ONLY on first line item
                    if (productIndex === 0) {
                        row[2] = "pending"; // Financial Status
                        row[4] = "fulfilled"; // Fulfillment Status
                        row[5] = `${order.deliveryDate.split('/').reverse().join('-')} 21:21:42 +0100`; // Fulfilled at
                        row[6] = "yes"; // Accepts Marketing
                        row[7] = "GBP"; // Currency
                        row[8] = order.total; // Subtotal
                        row[9] = 0; // Shipping
                        row[10] = 0; // Taxes
                        row[11] = order.total; // Total
                        row[14] = "FREE DELIVERY"; // Shipping Method
                        row[47] = "custom"; // Payment Method
                        row[49] = "0"; // Refunded Amount
                        row[51] = order.total; // Outstanding Balance
                        
                        // Billing/Shipping info - first row only
                        const customerName = customerMappings.get(order.customerCode) || order.customerName;
                        row[24] = `${customerName} (${order.customerCode})`; // Billing Name
                        row[25] = "Address Line 1"; // Billing Street
                        row[26] = "Address Line 1"; // Billing Address1
                        row[29] = "London"; // Billing City
                        row[30] = "SW1A 0AA"; // Billing Zip
                        row[31] = "ENG"; // Billing Province
                        row[32] = "GB"; // Billing Country
                        
                        // Shipping same as billing
                        row[34] = row[24]; // Shipping Name
                        row[35] = row[25]; // Shipping Street
                        row[36] = row[26]; // Shipping Address1
                        row[39] = row[29]; // Shipping City
                        row[40] = row[30]; // Shipping Zip
                        row[41] = "ENG"; // Shipping Province
                        row[42] = "GB"; // Shipping Country
                        
                        // Column AT (index 45) = Note Attributes with delivery date ONLY on first row
                        row[45] = `mw-delivery-date: ${order.deliveryDate.split('/').reverse().join('-')}`; // Note Attributes
                    } else {
                        // Leave order-level fields BLANK for additional line items
                        row[44] = ""; // Notes - empty for additional line items
                        row[45] = ""; // Note Attributes - BLANK on additional rows
                    }
                    
                    // Line item data - appears on ALL rows
                    row[15] = `${order.orderDate.split('/').reverse().join('-')} 20:29:32 +0100`; // Created at
                    row[16] = product.quantity; // Lineitem quantity (converted if applicable)
                    row[17] = product.description; // Lineitem name
                    row[18] = product.unitPrice; // Lineitem price
                    row[20] = product.productCode + getSKUSuffix(product); // Lineitem sku with suffix
                    row[21] = "TRUE"; // Lineitem requires shipping
                    row[22] = "FALSE"; // Lineitem taxable
                    row[23] = "fulfilled"; // Lineitem fulfillment status
                    
                    row[50] = getVendorForProduct(product.productCode); // Vendor (based on product type)
                    row[53] = "Unit 2 Horner House"; // Location
                    row[55] = `1.207${String(Math.floor(Math.random() * 100000)).padStart(5, '0')}E+13`; // Id
                    row[56] = "checkout-by-draft"; // Tags
                    row[57] = "Low"; // Risk Level
                    row[58] = "shopify_draft_order"; // Source
                    
                    // Tax columns and remaining fields - all empty except province names
                    row[73] = "England"; // Billing Province Name
                    row[74] = "England"; // Shipping Province Name
                    
                    wsData.push(row);
                }
            }
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            
            // Generate filename with current date
            const today = new Date().toISOString().split('T')[0];
            const filename = `freshware_orders_${today}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            // Save order history to Firebase AFTER successful export
            await saveOrderHistory(ordersToExport);
            
            // Update processed PO numbers for future duplicate detection
            ordersToExport.forEach(order => {
                if (order.poNumber) {
                    processedPONumbers.add(order.poNumber);
                }
            });
            
            // Show success message with conversion summary
            let successMessage = `✅ Export successful!\n\nFile: ${filename}\nApproved Orders: ${ordersToExport.length}\nTotal Products: ${ordersToExport.reduce((sum, order) => sum + order.products.length, 0)}`;
            
            // Add conversion summary if there were conversions
            const totalConverted = ordersToExport.reduce((sum, order) => 
                sum + order.products.filter(p => p.conversionApplied).length, 0);
            
            if (totalConverted > 0) {
                successMessage += `\n\nDecimal Conversions Applied: ${totalConverted}`;
            }
            
            if (totalWarnings > 0) {
                successMessage += `\nWarnings: ${totalWarnings} (may need attention)`;
            }
            
            successMessage += '\n\nReady for Freshware import!';
            
            alert(successMessage);
        }
        
        // Global function assignments
        window.approveCurrentOrder = approveCurrentOrder;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
